<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spieler Details</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .navbar {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .club-logo {
            
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
width: 32px;
    height: 32px;
    font-size: 1rem;
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .status-icon {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-aktiv {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .status-verletzt {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .status-reha {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .info-card h3 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .tabs {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .tab-buttons {
            display: flex;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            font-size: 0.95rem;
        }

        .tab-button {
            flex: 1;
            padding: 1.5rem;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-bottom-color: #f1c40f;
        }

        .tab-button:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .tab-content {
            display: none;
            padding: 1rem;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-weight: bold;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .own-player {
            background-color: #e3f2fd !important;
        }

        .current-player {
            background-color: #fff3cd !important;
            font-weight: bold;
        }

        .trend-up {
            color: #27ae60;
            font-weight: bold;
        }

        .trend-down {
            color: #e74c3c;
            font-weight: bold;
        }

        .attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .attribute-tag {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            text-align: center;
            color: #e74c3c;
            font-size: 1.2rem;
            margin: 2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .player-header {
                flex-direction: column;
                text-align: center;
            }

            .navbar {
                padding: 1rem;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <button class="back-btn" onclick="goBack()">‚Üê Zur√ºck</button>
        <div class="player-header">
            <div class="club-logo" id="clubLogo">?</div>
            <span class="player-name" id="playerName">Lade Spieler...</span>
            <span class="status-icon" id="statusIcon">Status</span>
        </div>
    </nav>

    <div class="container">
        <div id="loadingIndicator" class="loading-spinner"></div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="playerContent" style="display: none;">
            <div class="info-grid">
                <!-- Spieler-Informationen -->
                <div class="info-card">
                    <h3>üìã Spieler-Informationen</h3>
                    <div class="info-row">
                        <span class="info-label">Geburtstag:</span>
                        <span class="info-value" id="birthday">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Alter:</span>
                        <span class="info-value" id="age">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Gr√∂√üe:</span>
                        <span class="info-value" id="height">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Nationalit√§t:</span>
                        <span class="info-value" id="nationality">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Position:</span>
                        <span class="info-value" id="position">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Hauptfu√ü:</span>
                        <span class="info-value" id="foot">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Trikotnummer:</span>
                        <span class="info-value" id="jerseyNumber">-</span>
                    </div>
                </div>

                <!-- Comunio-Bereich -->
                <div class="info-card">
                    <h3>‚öΩ Comunio</h3>
                    <div class="info-row">
                        <span class="info-label">Position:</span>
                        <span class="info-value" id="comunioPosition">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Marktwert:</span>
                        <span class="info-value" id="marketValue">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Punkte (letztes Jahr):</span>
                        <span class="info-value" id="lastYearPoints">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Besitzer:</span>
                        <span class="info-value" id="owner">-</span>
                    </div>
                </div>

                <!-- Status & Statistik -->
                <div class="info-card">
                    <h3>üìä Status & Statistik</h3>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="detailStatus">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Spiele:</span>
                        <span class="info-value" id="gamesPlayed">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tore:</span>
                        <span class="info-value" id="goals">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Notenschnitt:</span>
                        <span class="info-value" id="averageRating">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Gelbe Karten:</span>
                        <span class="info-value" id="yellowCards">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Rote Karten:</span>
                        <span class="info-value" id="redCards">-</span>
                    </div>
                </div>
            </div>

            <!-- Attribute -->
            <div class="info-card" id="attributesCard" style="display: none;">
                <h3>‚≠ê Besondere Eigenschaften</h3>
                <div class="attributes" id="attributesList"></div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('rivals')">üë• Team Rivalen</button>
                    <button class="tab-button" onclick="showTab('points')">üìà Punktehistorie</button>
                    <button class="tab-button" onclick="showTab('market')">üí∞ Marktwert</button>
                </div>

                <!-- Team Rivalen Tab -->
                <div class="tab-content active" id="rivals">
                    <h4>Spieler der gleichen Position im Verein</h4>
                    <table class="data-table" id="rivalsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Marktwert</th>
                                <th>Punkte</th>
                                <th>Besitzer</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Punktehistorie Tab -->
                <div class="tab-content" id="points">
                    <h4>Aktuelle Saison (Spieltage 1-34)</h4>
                    <table class="data-table" id="currentSeasonTable">
                        <thead>
                            <tr>
                                <th>Spieltag</th>
                                <th>Punkte</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <h4 style="margin-top: 2rem;">Jahres√ºbersicht</h4>
                    <table class="data-table" id="yearlyTable">
                        <thead>
                            <tr>
                                <th>Jahr</th>
                                <th>Punkte</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Marktwert Tab -->
                <div class="tab-content" id="market">
                    <h4>Marktwertentwicklung</h4>
                    <table class="data-table" id="marketTable">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Wert</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen f√ºr die Daten
        let playerData = {};
        let marketData = {};
        let userData = {};
        let playerToUserMap = {};
        let clubData = {};
        let currentPlayerId = null;
        let allPlayerData = [];

        // URL Parameter auslesen
        function getPlayerId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Zur√ºck-Navigation
        function goBack() {
            window.history.back();
        }

        // Tab-Funktionalit√§t
        function showTab(tabName) {
            // Alle Tabs ausblenden
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Gew√§hlten Tab anzeigen
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Alter berechnen
        function calculateAge(birthday) {
            if (!birthday || birthday === 'N/A') return '-';
            try {
                const birth = new Date(birthday.split('.').reverse().join('-'));
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age + ' Jahre';
            } catch {
                return '-';
            }
        }

        // Marktwert formatieren
        function formatCurrencyShort(value) {
            if (!value || value === 0) return '-';
            
            if (value >= 1000000) {
                return (value / 1000000).toFixed(1).replace('.0', '') + ' Mio ‚Ç¨';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(0) + ' Tsd ‚Ç¨';
            }
            return value.toLocaleString('de-DE') + ' ‚Ç¨';
        }

        // Besitzer-Namen finden
        function getOwnerName(playerId) {
            const userId = playerToUserMap[playerId];
            if (!userId || userId === "1") return "Computer";
            const user = userData.find(u => u.user.id === userId);
            return user ? user.user.firstName + (user.user.lastName ? ' ' + user.user.lastName : '') : 'Unbekannt';
        }

        // Vereins-Namen finden
        function getClubName(clubId) {
            const club = clubData.find(c => c.id === clubId);
            return club ? club.name : 'Unbekannt';
        }

        // Team-Rivalen laden
        function loadTeamRivals(player) {
            const sameClubPlayers = allPlayerData.filter(p => 
                p.data.verein === player.data.verein && 
                p.data.position === player.data.position
            );

            const tbody = document.querySelector('#rivalsTable tbody');
            tbody.innerHTML = '';

            sameClubPlayers.forEach(p => {
                const row = tbody.insertRow();
                const isOwnPlayer = getOwnerName(p.id) !== 'Computer';
                const isCurrentPlayer = p.id === currentPlayerId;

                if (isCurrentPlayer) {
                    row.classList.add('current-player');
                } else if (isOwnPlayer) {
                    row.classList.add('own-player');
                }

                row.style.cursor = 'pointer';
                row.addEventListener('click', () => {
                    window.open(`https://htmlpreview.github.io/?https://github.com/torresbig/comunioFanApp/blob/main/player.html?id=${p.id}`, '_blank');
                });

                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${formatCurrencyShort(p.data.wert)}</td>
                    <td>${p.data.punkte || 0}</td>
                    <td>${getOwnerName(p.id)}</td>
                `;
            });
        }

        // Punktehistorie laden
        function loadPointsHistory(player) {
            const history = player.data.punkteHistorie || [];
            
            // Aktuelle Saison (Spieltage 1-34)
            const currentSeasonTbody = document.querySelector('#currentSeasonTable tbody');
            currentSeasonTbody.innerHTML = '';
            
            for (let i = 1; i <= 34; i++) {
                const row = currentSeasonTbody.insertRow();
                const points = history.find(h => h.key === i);
                row.innerHTML = `
                    <td>${i}</td>
                    <td>${points ? points.value : 0}</td>
                `;
            }

            // Jahres√ºbersicht (key > 50)
            const yearlyTbody = document.querySelector('#yearlyTable tbody');
            yearlyTbody.innerHTML = '';
            
            const yearlyPoints = history.filter(h => h.key > 50).sort((a, b) => b.key - a.key);
            yearlyPoints.forEach(point => {
                const row = yearlyTbody.insertRow();
                row.innerHTML = `
                    <td>${point.key}</td>
                    <td>${point.value}</td>
                `;
            });
        }

        // Marktwertentwicklung laden
        function loadMarketHistory(playerId) {
            const playerMarketData = marketData.find(m => m.id === playerId);
            const tbody = document.querySelector('#marketTable tbody');
            tbody.innerHTML = '';

            if (!playerMarketData || !playerMarketData.data.normal) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="3">Keine Marktwertdaten verf√ºgbar</td>';
                return;
            }

            const values = playerMarketData.data.normal.slice(0, 20); // Nur die letzten 20 Eintr√§ge
            values.forEach((entry, index) => {
                const row = tbody.insertRow();
                let trendIcon = '';
                let trendClass = '';

                if (index < values.length - 1) {
                    const nextValue = values[index + 1].wert;
                    if (entry.wert > nextValue) {
                        trendIcon = '‚Üó';
                        trendClass = 'trend-up';
                    } else if (entry.wert < nextValue) {
                        trendIcon = '‚Üò';
                        trendClass = 'trend-down';
                    } else {
                        trendIcon = '‚Üí';
                    }
                }

                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${formatCurrencyShort(entry.wert)}</td>
                    <td class="${trendClass}">${trendIcon}</td>
                `;
            });
        }

        // Attribute anzeigen
        function displayAttributes(player) {
            const attributesCard = document.getElementById('attributesCard');
            const attributesList = document.getElementById('attributesList');
            
            if (player.data.attribute && player.data.attribute.length > 0) {
                attributesCard.style.display = 'block';
                attributesList.innerHTML = '';
                
                player.data.attribute.forEach(attr => {
                    Object.values(attr).forEach(values => {
                        if (Array.isArray(values)) {
                            values.forEach(value => {
                                const tag = document.createElement('span');
                                tag.className = 'attribute-tag';
                                tag.textContent = value;
                                attributesList.appendChild(tag);
                            });
                        } else if (typeof values === 'string') {
                            const tag = document.createElement('span');
                            tag.className = 'attribute-tag';
                            tag.textContent = values;
                            attributesList.appendChild(tag);
                        }
                    });
                });
            } else {
                attributesCard.style.display = 'none';
            }
        }

        // Spieler-Details laden
        function loadPlayerDetails(playerId) {
            currentPlayerId = playerId;
            const player = allPlayerData.find(p => p.id === playerId);
            
            if (!player) {
                showError('Spieler nicht gefunden!');
                return;
            }

            // Header aktualisieren
            document.getElementById('playerName').textContent = player.name;
            
            // Club Logo (nur Initialen)
            const clubName = getClubName(player.data.verein);
            const clubInitials = clubName.split(' ').map(word => word[0]).join('').substring(0, 3);
            document.getElementById('clubLogo').textContent = clubInitials;
            
            // Status-Icon
            const statusIcon = document.getElementById('statusIcon');
            const status = player.data.comunioStatus.status;
            statusIcon.textContent = getStatusDisplayName(status);
            statusIcon.className = `status-icon status-${status.toLowerCase()}`;

            // Spieler-Informationen
            const birthday = player.data.spielerDaten.geburtstag;
            document.getElementById('birthday').textContent = birthday !== 'N/A' ? birthday : '-';
            document.getElementById('age').textContent = calculateAge(birthday);
            document.getElementById('height').textContent = player.data.spielerDaten.groesse || '-';
            document.getElementById('nationality').textContent = player.data.spielerDaten.nationalitaet || '-';
            document.getElementById('position').textContent = player.data.spielerDaten.hauptposition || player.data.position || '-';
            document.getElementById('foot').textContent = player.data.spielerDaten.fuss || '-';
            document.getElementById('jerseyNumber').textContent = player.data.spielerDaten.trikotNummer || '-';

            // Comunio-Daten
            document.getElementById('comunioPosition').textContent = player.data.position || '-';
            document.getElementById('marketValue').textContent = formatCurrencyShort(player.data.wert);
            document.getElementById('lastYearPoints').textContent = player.data.lastSeasonPoints || 0;
            document.getElementById('owner').textContent = getOwnerName(playerId);

            // Status & Statistik
            document.getElementById('detailStatus').textContent = player.data.comunioStatus.details || getStatusDisplayName(status);
            document.getElementById('gamesPlayed').textContent = player.data.stats.playedGames || 0;
            document.getElementById('goals').textContent = player.data.stats.totalGoals || 0;
            document.getElementById('averageRating').textContent = player.data.stats.notenDurchschnitt || '-';
            document.getElementById('yellowCards').textContent = player.data.stats.gelbekarten || 0;
            document.getElementById('redCards').textContent = player.data.stats.rotekarten || 0;

            // Attribute anzeigen
            displayAttributes(player);

            // Tabs laden
            loadTeamRivals(player);
            loadPointsHistory(player);
            loadMarketHistory(playerId);

            // Content anzeigen
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('playerContent').style.display = 'block';
        }

        function getStatusDisplayName(status) {
            const statusMap = {
                'AKTIV': 'Aktiv',
                'VERLETZT': 'Verletzt',
                'REHA': 'Reha',
                'NICHT_IN_LIGA': 'Nicht in Liga'
            };
            return statusMap[status] || status || 'Unbekannt';
        }

        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Daten laden
        async function loadData() {
  try {
    const responses = await Promise.all([
      fetch('https://raw.githubusercontent.com/torresbig/comunioFanApp/main/SpielerdatenbankNeutralJson.txt'),
      fetch('https://raw.githubusercontent.com/torresbig/comunioFanApp/main/MarktwerteJson.txt'),
      fetch('https://raw.githubusercontent.com/torresbig/comunioFanApp/main/UserdatenbankJson_884691.txt'),
      fetch('https://raw.githubusercontent.com/torresbig/comunioFanApp/main/PlayerToUserMap_884691.txt'),
      fetch('https://raw.githubusercontent.com/torresbig/comunivFanApp/main/VereinsdatenbankJson.txt')
    ]);

                const [playerResp, marketResp, userResp, mapResp, clubResp] = responses;
                
                allPlayerData = await playerResp.json();
                marketData = await marketResp.json();
                userData = await userResp.json();
                const mapData = await mapResp.json();
                clubData = await clubResp.json();

                // Player-to-User Map verarbeiten
                playerToUserMap = {};
                mapData.forEach(item => {
                    Object.assign(playerToUserMap, item);
                });

                // Spieler-Details laden
                const playerId = getPlayerId();
                if (playerId) {
                    loadPlayerDetails(playerId);
                } else {
                    showError('Keine Spieler-ID angegeben!');
                }

            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                showError('Fehler beim Laden der Daten');
            }
        }

        // Seite laden
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
