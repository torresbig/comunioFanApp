<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spieler Details</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; padding-bottom: 140px; margin: 0;}
    .navbar { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
    .player-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto; padding: 10px 0;}
    .player-center { display: flex; flex-direction: column; align-items: center; flex: 1;}
    .player-row { display: flex; align-items: center; gap: 12px; justify-content: center;}
    .club-logo { width: 44px; height: 44px; border-radius: 50%; background: #3498db; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center;}
    .club-logo img { width: 100%; height: 100%; object-fit: contain;}
    .player-name { font-size: 22px; font-weight: bold; color: white; text-decoration: none; line-height: 1.1;}
    .player-name:hover { text-decoration: underline;}
    .player-id { font-size: 13px; color: #aaa; margin-top: 2px; text-align: left; width: 100%;}
    .status-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; gap: 2px;}
    .status-label { font-size: 12px; color: #aaa;}
    .status-indicator { font-size: 26px; cursor: help; transition: opacity 0.2s;}
    .status-indicator:hover { opacity: 0.8;}
    .container { max-width: 1200px; margin: 0 auto; padding: 15px;}
    .info-card { background: rgba(255,255,255,0.95); border-radius: 10px; padding: 15px 20px 10px 20px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);}
    .info-card h3 { margin-bottom: 12px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; font-size: 16px; display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;}
    .info-card h3:after { content: "‚ñº"; font-size: 0.8em; margin-left: 10px; display: inline-block; transition: transform 0.2s;}
    .info-card h3.collapsed:after { transform: rotate(-90deg);}
    .info-card-content { overflow: hidden; max-height: 1000px; transition: max-height 0.3s ease-out;}
    .info-card-content.collapsed { max-height: 0;}
    .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 5px 0; border-bottom: 1px solid #eee;}
    .info-row:last-child { border-bottom: none;}
    .info-label { font-weight: 600; color: #7f8c8d; font-size: 13px; flex: 1;}
    .info-value { font-weight: 600; color: #2c3e50; font-size: 13px; flex: 1; text-align: right;}
    .attributes { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;}
    .attribute-tag { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 4px 8px; border-radius: 15px; font-size: 12px; font-weight: 600;}
    .tabs { display: flex; justify-content: center; margin: 20px 0 0 0; border-bottom: 1px solid #ddd;}
    .tab-button { position:relative; padding: 10px 20px; background: #2c3e50; color: white; border: none; cursor: pointer; font-size: 22px; margin: 0 5px; border-radius: 16px 16px 0 0; transition: background 0.3s; display: flex; align-items: center;}
    .tab-button.active { background: #3498db;}
    .tab-button .trend-arrow { display: flex; align-items: center; margin-left: 7px;}
    .tab-content { display: none; padding: 15px; background: rgba(255,255,255,0.95); border-radius: 0 0 10px 10px;}
    .tab-content.active { display: block;}
    /* Rivalen-Tabelle */
    .rivals-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        font-size: 15px;
    }
    .rivals-table th, .rivals-table td {
        padding: 12px 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
        font-size: 13px;
    }
    .rivals-table th {
        background-color: #2c3e50;
        color: white;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 25px;
    }
    .rivals-table th:hover {
        background-color: #34495e;
    }
    .rivals-table tr:nth-child(even) { background-color: #f9f9f9; }
    .rivals-table tr:hover { background-color: #f1f7ff; }
    .player-name-cell { font-weight: 600; color: #2c3e50; }
    .player-id-cell { font-size: 11px; color: #aaa; margin-top: 2px; }
    .sort-arrow {
        position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 12px;
    }
    .player-link { color: #3498db; text-decoration: underline; }
    .player-link:hover { color: #217dbb; }
    /* Punkte-Tabelle */
    .points-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: #f9f9ff;
        border-radius: 10px;
        overflow: hidden;
        font-size: 15px;
    }
    .points-table th, .points-table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #e3e7fa;
    }
    .points-table th {
        background: #e3e7fa;
        color: #2c3e50;
        font-weight: 600;
    }
    .points-table tr:nth-child(even) { background: #f6f8fa; }
    .points-table tr:hover { background: #eef2fa; }
    .matchday-cell { font-weight: 600; color: #2c3e50; }
    .points-cell { font-weight: 600; color: #27ae60; }
    @media (max-width: 600px) {
        .container { padding: 5px; }
        .player-name { font-size: 16px; }
        .club-logo { width: 34px; height: 34px; }
        .tab-button { font-size: 16px; }
    }
</style>
</head>
<body>
<nav class="navbar">
    <button class="back-btn" onclick="window.history.back()">‚Üê Zur√ºck</button>
    <div class="player-header">
        <div class="player-center">
            <div class="player-row">
                <div class="club-logo" id="clubLogo"></div>
                <div>
                    <a href="#" id="playerNameLink" class="player-name" target="_blank">Lade Spieler...</a>
                    <div id="playerId" class="player-id"></div>
                </div>
            </div>
        </div>
        <div class="status-wrapper">
            <div class="status-label">Status</div>
            <div id="statusIndicator" class="status-indicator"></div>
        </div>
    </div>
</nav>
<div class="container">
    <div id="errorMessage" class="error-message" style="display:none; color: red; font-weight: bold; margin-bottom: 10px;"></div>
    <div id="loadingIndicator" class="loading-spinner" style="text-align:center; padding: 20px;">Lade Daten...</div>
    <div id="playerContent" style="display:none;">
        <div class="info-card">
            <h3>üìã Spieler-Informationen</h3>
            <div class="info-card-content">
                <div class="info-row"><span class="info-label">Geburtstag:</span><span class="info-value" id="birthday">-</span></div>
                <div class="info-row"><span class="info-label">Alter:</span><span class="info-value" id="age">-</span></div>
                <div class="info-row"><span class="info-label">Gr√∂√üe:</span><span class="info-value" id="height">-</span></div>
                <div class="info-row"><span class="info-label">Nationalit√§t:</span><span class="info-value" id="nationality">-</span></div>
                <div class="info-row"><span class="info-label">Position:</span><span class="info-value" id="position">-</span></div>
                <div class="info-row"><span class="info-label">Hauptfu√ü:</span><span class="info-value" id="foot">-</span></div>
                <div class="info-row"><span class="info-label">Trikotnummer:</span><span class="info-value" id="jerseyNumber">-</span></div>
            </div>
        </div>
        <div class="info-card">
            <h3>‚öΩ Comunio</h3>
            <div class="info-card-content">
                <div class="info-row"><span class="info-label">Position:</span><span class="info-value" id="comunioPosition">-</span></div>
                <div class="info-row"><span class="info-label">Marktwert:</span><span class="info-value" id="marketValue">-</span></div>
                <div class="info-row"><span class="info-label">Punkte (letztes Jahr):</span><span class="info-value" id="lastYearPoints">-</span></div>
                <div class="info-row"><span class="info-label">Besitzer:</span><span class="info-value" id="owner">-</span></div>
            </div>
        </div>
        <div class="info-card">
            <h3>
                <svg class="stat-icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="13" width="3" height="8" rx="1" fill="#764ba2"/><rect x="8" y="9" width="3" height="12" rx="1" fill="#764ba2"/><rect x="13" y="5" width="3" height="16" rx="1" fill="#764ba2"/><rect x="18" y="2" width="3" height="19" rx="1" fill="#764ba2"/></svg>
                Status & Statistik
            </h3>
            <div class="info-card-content">
                <div class="info-row"><span class="info-label">Status:</span><span class="info-value" id="detailStatus">-</span></div>
                <div class="info-row"><span class="info-label">Spiele:</span><span class="info-value" id="gamesPlayed">-</span></div>
                <div class="info-row"><span class="info-label">Tore:</span><span class="info-value" id="goals">-</span></div>
                <div class="info-row"><span class="info-label">Notenschnitt:</span><span class="info-value" id="averageRating">-</span></div>
                <div class="info-row"><span class="info-label">Gelbe Karten:</span><span class="info-value" id="yellowCards">-</span></div>
                <div class="info-row"><span class="info-label">Rote Karten:</span><span class="info-value" id="redCards">-</span></div>
            </div>
        </div>
        <div class="info-card" id="attributesCard" style="display:none;">
            <h3>‚≠ê Besondere Eigenschaften</h3>
            <div class="info-card-content">
                <div class="attributes" id="attributesList"></div>
            </div>
        </div>
        <div class="tabs" id="tabBar">
            <button class="tab-button" data-tab="rivals">Rivalen</button>
            <button class="tab-button" data-tab="market">Marktwerte <span id="marketTabTrend" class="trend-arrow"></span></button>
            <button class="tab-button" data-tab="points">Punkte</button>
        </div>
        <div id="rivals" class="tab-content">
            <h3 id="rivalsHeader">Direkte Konkurrenten</h3>
            <div id="rivalsList"></div>
        </div>
        <div id="market" class="tab-content">
            <div id="marketValueChart"></div>
        </div>
        <div id="points" class="tab-content">
            <div id="pointsHistory"></div>
        </div>
    </div>
</div>
<script>
const MONATSNAMEN = [
    "Januar", "Februar", "M√§rz", "April", "Mai", "Juni",
    "Juli", "August", "September", "Oktober", "November", "Dezember"
];
const GITHUB_USER = "torresbig";
const GITHUB_REPO = "comunioFanApp";
let globalOwnersMap = new Map();

function fetchJSON(url) {
    const cacheBusterUrl = url + '?t=' + new Date().getTime();
    return fetch(cacheBusterUrl).then(res => {
        if (!res.ok) throw new Error(`HTTP Fehler ${res.status} beim Laden von ${url}`);
        return res.json();
    });
}

async function loadOwnersData() {
    try {
        const [usersData, playerToUserMap] = await Promise.all([
            fetchJSON(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/UserdatenbankJson_884691.txt`),
            fetchJSON(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/PlayerToUserMap_884691.txt`)
        ]);
        const userMap = new Map();
        usersData.forEach(user => {
            userMap.set(user.user.id, `${user.user.firstName} ${user.user.lastName || ''}`);
        });
        playerToUserMap.forEach(item => {
            const playerId = Object.keys(item)[0];
            const ownerId = item[playerId];
            globalOwnersMap.set(playerId, userMap.get(ownerId) || `Unbekannt (${ownerId})`);
        });
    } catch (e) {
        console.error("Fehler beim Laden der Besitzerdaten:", e);
    }
}

function formatCurrencyFull(value) {
    if (!value || value === 0) return '-';
    return value.toLocaleString('de-DE') + ' ‚Ç¨';
}

function getStatusIndicator(status) {
    switch(status) {
        case 'AKTIV': return 'üëç';
        case 'VERLETZT': return 'üö®';
        case 'REHA': return 'üîÑ';
        case 'AUFBAUTRAINING': return 'üèãÔ∏èüí™';
        case 'NICHT_IN_LIGA': return '‚ùå';
        case 'FUENFTE_GELBE_KARTE': return 'üü®';
        case 'GELBROTE_KARTE': return 'üü®üü•';
        case 'ROTE_KARTE': return 'üü•';
        case 'NICHT_IM_KADER': return 'üö´';
        default: return '‚ùì';
    }
}

function getStatusDisplayName(status) {
    const statusMap = {
        'AKTIV': 'Aktiv',
        'VERLETZT': 'Verletzt',
        'REHA': 'Reha',
        'AUFBAUTRAINING': 'Aufbautraining',
        'NICHT_IM_KADER': 'Nicht im Kader',
        'ROTE_KARTE': 'Rote Karte',
        'GELBROTE_KARTE': 'Gelbrote Karte',
        'FUENFTE_GELBE_KARTE': '5. gelbe Karte',
        'NICHT_IN_LIGA': 'Nicht in Liga'
    };
    return statusMap[status] || status || 'Unbekannt';
}

function getPlayerUrl(playerId) {
    const currentUrl = window.location.href;
    if (currentUrl.includes('htmlpreview.github.io')) {
        return `https://htmlpreview.github.io/?https://github.com/torresbig/comunioFanApp/blob/main/player.html?id=${playerId}`;
    } else if (currentUrl.includes('github.com') || currentUrl.includes('githubusercontent.com')) {
        return `https://htmlpreview.github.io/?https://github.com/torresbig/comunioFanApp/blob/main/player.html?id=${playerId}`;
    } else {
        return `player.html?id=${playerId}`;
    }
}

function makeTableSortable(tableSelector, defaultSortCol = 0, defaultSortDir = 'desc') {
    const table = document.querySelector(tableSelector);
    if (!table) return;
    const ths = table.querySelectorAll('th');
    let sortCol = defaultSortCol;
    let sortDir = defaultSortDir;

    function sortTable(colIndex, dir) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aCell = a.children[colIndex];
            const bCell = b.children[colIndex];
            let aValue = aCell.getAttribute('data-sort') || aCell.textContent;
            let bValue = bCell.getAttribute('data-sort') || bCell.textContent;
            if ([2, 3, 4].includes(colIndex)) {
                aValue = parseFloat(aValue.replace(/[^\d.-]/g, '')) || 0;
                bValue = parseFloat(bValue.replace(/[^\d.-]/g, '')) || 0;
                return dir === 'asc' ? aValue - bValue : bValue - aValue;
            } else {
                aValue = aValue.toString().toLowerCase();
                bValue = bValue.toString().toLowerCase();
                if (aValue < bValue) return dir === 'asc' ? -1 : 1;
                if (aValue > bValue) return dir === 'asc' ? 1 : -1;
                return 0;
            }
        });
        rows.forEach(row => tbody.appendChild(row));
    }

    ths.forEach((th, i) => {
        th.style.cursor = 'pointer';
        let arrowSpan = th.querySelector('.sort-arrow');
        if (!arrowSpan) {
            arrowSpan = document.createElement('span');
            arrowSpan.className = 'sort-arrow';
            th.appendChild(arrowSpan);
        }
        th.addEventListener('click', () => {
            ths.forEach(h => h.querySelector('.sort-arrow').textContent = '');
            if (sortCol === i) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortCol = i;
                sortDir = 'asc';
            }
            arrowSpan.textContent = sortDir === 'asc' ? '‚ñ≤' : '‚ñº';
            sortTable(sortCol, sortDir);
        });
    });

    sortTable(sortCol, sortDir);
    if (ths[sortCol]) {
        ths[sortCol].querySelector('.sort-arrow').textContent = sortDir === 'asc' ? '‚ñ≤' : '‚ñº';
    }
}

function displayRivals(player, allPlayers) {
    const container = document.getElementById('rivalsList');
    const header = document.getElementById('rivalsHeader');
    if (!container) return;
    const rivals = allPlayers.filter(p => 
        p.data?.position === player.data?.position &&
        p.data?.verein === player.data?.verein 
    ).sort((a,b) => b.data?.wert - a.data?.wert);

    header.textContent = `${rivals.length} Direkte Konkurrenten`;

    if (rivals.length > 0) {
        let html = `
        <table class="rivals-table">
            <thead>
                <tr>
                    <th>Spieler</th>
                    <th>Status</th>
                    <th>Marktwert</th>
                    <th>Realwert</th>
                    <th>Punkte</th>
                    <th>Besitzer</th>
                </tr>
            </thead>
            <tbody>
        `;
        rivals.forEach(rival => {
            const statusData = rival.data.comunioStatus || {};
            const statusTooltip = `${getStatusDisplayName(statusData.status)}${statusData.grund ? ' - ' + statusData.grund : ''}${statusData.seit ? ' seit ' + statusData.seit : ''}`;
            const ownerName = globalOwnersMap.get(rival.id) || "Computer";
            const playerUrl = getPlayerUrl(rival.id);

            html += `
            <tr data-player-id="${rival.id}">
                <td class="player-cell" data-sort="${rival.name}">
                    <div class="player-name-cell">
                        <a href="${playerUrl}" class="player-link" title="Zum Spieler">${rival.name}</a>
                    </div>
                    <div class="player-id-cell">(${rival.id})</div>
                </td>
                <td data-sort="${statusData.status || ''}">
                    <span class="status-indicator" title="${statusTooltip}">
                        ${getStatusIndicator(statusData.status)}
                    </span>
                </td>
                <td data-sort="${rival.data?.wert || 0}">${formatCurrencyFull(rival.data?.wert || 0)}</td>
                <td data-sort="${rival.data?.realWert || 0}">${formatCurrencyFull(rival.data?.realWert || 0)}</td>
                <td data-sort="${rival.data?.punkte || 0}">${rival.data?.punkte || 0}</td>
                <td data-sort="${ownerName}">${ownerName}</td>
            </tr>
            `;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        makeTableSortable('.rivals-table', 2, 'desc');
    } else {
        container.innerHTML = '<p>Keine direkten Konkurrenten gefunden</p>';
    }
}

function displayPointsHistory(player) {
    const container = document.getElementById('pointsHistory');
    if (!container) return;
    const spieltagspunkte = player.data?.spieltagspunkte || [];
    const pointsHistory = player.data?.punkteHistorie || [];
    const currentSeason = new Date().getFullYear();

    // Aktuelle Saison als Matrix (4 Spalten: Spieltag + Punkte)
    let html = `<h3>Aktuelle Saison (${currentSeason})</h3>
    <table class="points-table">
        <thead>
            <tr>
                <th>Spieltag</th><th>Punkte</th>
                <th>Spieltag</th><th>Punkte</th>
                <th>Spieltag</th><th>Punkte</th>
                <th>Spieltag</th><th>Punkte</th>
            </tr>
        </thead>
        <tbody>
    `;
    for (let i = 1; i <= 34; i += 4) {
        html += '<tr>';
        for (let j = 0; j < 4; j++) {
            const spieltag = i + j;
            if (spieltag > 34) {
                html += '<td></td><td></td>';
            } else {
                const punktEntry = spieltagspunkte.find(p => p.spieltag === spieltag);
                const punkte = punktEntry ? punktEntry.punkte : '-';
                html += `<td class="matchday-cell">${spieltag}</td><td class="points-cell">${punkte}</td>`;
            }
        }
        html += '</tr>';
    }
    html += '</tbody></table>';

    // Historische Saisons
    if (pointsHistory.length > 0) {
        html += '<h3>Historische Saisons</h3>';
        html += '<table class="points-table"><thead><tr><th>Saison</th><th>Punkte</th></tr></thead><tbody>';
        pointsHistory.forEach(season => {
            html += `<tr><td>${season.key}</td><td>${season.value}</td></tr>`;
        });
        html += '</tbody></table>';
    }
    container.innerHTML = html;
}

function calcAge(birthday) {
    if (!birthday || birthday === 'N/A') return '-';
    try {
        const birthDate = new Date(birthday.split('.').reverse().join('-'));
        const diff = Date.now() - birthDate.getTime();
        const ageDate = new Date(diff);
        return Math.abs(ageDate.getUTCFullYear() - 1970) + ' Jahre';
    } catch {
        return '-';
    }
}

function displayAttributes(player) {
    const container = document.getElementById('attributesList');
    const card = document.getElementById('attributesCard');
    if (!container) return;
    container.innerHTML = '';
    let found = false;
    if (player.data.attribute && player.data.attribute.length > 0) {
        player.data.attribute.forEach(attr => {
            if (typeof attr === 'object' && attr !== null) {
                Object.keys(attr).forEach(key => {
                    const value = attr[key];
                    if (Array.isArray(value)) {
                        value.forEach(item => {
                            const span = document.createElement('span');
                            span.className = 'attribute-tag';
                            span.textContent = item;
                            container.appendChild(span);
                            found = true;
                        });
                    } else if (typeof value === 'string') {
                        const span = document.createElement('span');
                        span.className = 'attribute-tag';
                        span.textContent = value;
                        container.appendChild(span);
                        found = true;
                    }
                });
            } else if (typeof attr === 'string') {
                const span = document.createElement('span');
                span.className = 'attribute-tag';
                span.textContent = attr;
                container.appendChild(span);
                found = true;
            }
        });
    }
    card.style.display = found ? '' : 'none';
}

function setupAccordion() {
    const infoCards = document.querySelectorAll('.info-card');
    infoCards.forEach(card => {
        const header = card.querySelector('h3');
        const content = card.querySelector('.info-card-content');
        header.onclick = () => {
            content.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        };
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    await loadOwnersData();
    initTabs();
    const url = window.location.href;
    const idMatch = url.match(/[?&]id=([^&]*)/);
    const playerId = idMatch ? idMatch[1] : null;
    if (!playerId) {
        document.getElementById('errorMessage').textContent = "Keine Spieler-ID angegeben!";
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingIndicator').style.display = 'none';
        return;
    }
    try {
        const resp = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/SpielerdatenbankNeutralJson.txt`);
        const allPlayers = await resp.json();
        let player = allPlayers.find(p => String(p.id) === String(playerId));
        if (!player) player = allPlayers.find(p => parseInt(p.id) === parseInt(playerId));
        if (!player) {
            document.getElementById('errorMessage').textContent = "Spieler nicht gefunden!";
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'none';
            return;
        }
        document.getElementById('playerNameLink').textContent = player.name;
        document.getElementById('playerId').textContent = `ID: ${player.id}`;
        if (player.data && player.data.transfermarktDoDe && player.data.transfermarktDoDe.link) {
            document.getElementById('playerNameLink').href = player.data.transfermarktDoDe.link;
        } else {
            document.getElementById('playerNameLink').href = "#";
            document.getElementById('playerNameLink').style.cursor = "default";
            document.getElementById('playerNameLink').style.textDecoration = "none";
        }
        const clubId = player.data.verein || "0";
        function getLogoFileName(clubId) {
            if (!clubId) return "unbestimmt.png";
            const mapping = {
                "3": "gladbach", "21": "freiburg", "18": "mainz", "92": "leipzig",
                "1": "bayern", "6": "werderBremen", "12": "wolfsburg", "5": "dortmund",
                "8": "leverkusen", "13": "koeln", "14": "stuttgart", "533": "hoffenheim",
                "68": "augsburg", "9": "frankfurt", "109": "unionBerlin", "110": "heidenheim",
                "25": "stpauli", "4": "hamburg",
            };
            return (mapping[clubId] || "unbestimmt") + ".png";
        }
        document.getElementById('clubLogo').innerHTML =
            `<img src="logos/${getLogoFileName(clubId)}" alt="" style="width:100%;height:100%;object-fit:contain">`;
        const status = player.data.comunioStatus?.status || 'Unbekannt';
        document.getElementById('statusIndicator').textContent = getStatusIndicator(status);
        document.getElementById('birthday').textContent = player.data.spielerDaten.geburtstag || '-';
        document.getElementById('age').textContent = calcAge(player.data.spielerDaten.geburtstag) || '-';
        document.getElementById('height').textContent = player.data.spielerDaten.groesse || '-';
        document.getElementById('nationality').textContent = player.data.spielerDaten.nationalitaet || '-';
        document.getElementById('position').textContent = player.data.spielerDaten.hauptposition || player.data.position || '-';
        document.getElementById('foot').textContent = player.data.spielerDaten.fuss || '-';
        document.getElementById('jerseyNumber').textContent = player.data.spielerDaten.trikotNummer || '-';
        document.getElementById('comunioPosition').textContent = player.data.position || '-';
        document.getElementById('marketValue').textContent = formatCurrencyFull(player.data.wert);
        document.getElementById('lastYearPoints').textContent = player.data.lastSeasonPoints || '0';
        document.getElementById('owner').textContent = globalOwnersMap.get(player.id) || '-';
        document.getElementById('detailStatus').textContent = player.data.comunioStatus?.details || getStatusDisplayName(status);
        document.getElementById('gamesPlayed').textContent = player.data.stats?.playedGames || '0';
        document.getElementById('goals').textContent = player.data.stats?.totalGoals || '0';
        document.getElementById('averageRating').textContent = player.data.stats?.notenDurchschnitt || '0';
        document.getElementById('yellowCards').textContent = player.data.stats?.gelbekarten || '0';
        document.getElementById('redCards').textContent = player.data.stats?.rotekarten || '0';
        displayAttributes(player);
        displayRivals(player, allPlayers);
        displayPointsHistory(player);
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('playerContent').style.display = 'block';

        setupAccordion();
    } catch (err) {
        document.getElementById('errorMessage').textContent = "Fehler beim Laden der Daten: " + err.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingIndicator').style.display = 'none';
    }
});

function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(tab => tab.classList.remove('active'));
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(tab => tab.classList.remove('active'));
    document.querySelector('.tab-button[data-tab="market"]').classList.add('active');
    document.getElementById('market').classList.add('active');
}
</script>
</body>
</html>
