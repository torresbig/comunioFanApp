<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spielerprofil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.4;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .team-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .player-title {
            flex: 1;
            font-size: 18px;
            font-weight: bold;
        }

        .status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-aktiv { background-color: #27ae60; }
        .status-verletzt { background-color: #e74c3c; }
        .status-nicht-in-liga { background-color: #95a5a6; }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-label {
            font-weight: bold;
            color: #7f8c8d;
        }

        .info-value {
            color: #2c3e50;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #ecf0f1;
            cursor: pointer;
            border: none;
            font-size: 14px;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .player-own {
            background-color: #e3f2fd !important;
        }

        .player-current {
            background-color: #ffeb3b !important;
            font-weight: bold;
        }

        .trend-up {
            color: #27ae60;
        }

        .trend-down {
            color: #e74c3c;
        }

        .attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .attribute-tag {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                border-bottom: 1px solid #bdc3c7;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="goBack()">← Zurück</button>
        <div class="team-logo" id="teamLogo"></div>
        <div class="player-title" id="playerTitle">
            <span id="playerName"></span>
            <span class="status-icon" id="statusIcon"></span>
        </div>
    </div>

    <div class="container">
        <!-- Spieler Informationen -->
        <div class="info-card">
            <h3>Spielerinformationen</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Geburtstag:</span>
                    <span class="info-value" id="geburtstag"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Größe:</span>
                    <span class="info-value" id="groesse"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Nationalität:</span>
                    <span class="info-value" id="nationalitaet"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Position:</span>
                    <span class="info-value" id="position"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Hauptfuß:</span>
                    <span class="info-value" id="fuss"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Trikotnummer:</span>
                    <span class="info-value" id="trikotNummer"></span>
                </div>
            </div>
        </div>

        <!-- Comunio Informationen -->
        <div class="info-card">
            <h3>Comunio</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Position:</span>
                    <span class="info-value" id="comunioPosition"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Marktwert:</span>
                    <span class="info-value" id="marktwert"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Punkte (letztes Jahr):</span>
                    <span class="info-value" id="punkteLetztesJahr"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Besitzer:</span>
                    <span class="info-value" id="besitzer"></span>
                </div>
            </div>
        </div>

        <!-- Status -->
        <div class="info-card">
            <h3>Status</h3>
            <div class="info-item">
                <span class="info-label">Status:</span>
                <span class="info-value" id="statusText"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Details:</span>
                <span class="info-value" id="statusDetails"></span>
            </div>
        </div>

        <!-- Statistiken -->
        <div class="info-card">
            <h3>Statistiken</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Spiele:</span>
                    <span class="info-value" id="playedGames"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Tore:</span>
                    <span class="info-value" id="totalGoals"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Notendurchschnitt:</span>
                    <span class="info-value" id="notenDurchschnitt"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Gelbe Karten:</span>
                    <span class="info-value" id="gelbeKarten"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Rote Karten:</span>
                    <span class="info-value" id="roteKarten"></span>
                </div>
            </div>
        </div>

        <!-- Attribute -->
        <div class="info-card" id="attributeCard" style="display: none;">
            <h3>Besondere Leistungen & Skills</h3>
            <div id="attributeContainer"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('teamRivalen')">Team-Rivalen</button>
            <button class="tab" onclick="showTab('punktehistorie')">Punktehistorie</button>
            <button class="tab" onclick="showTab('marktwerte')">Marktwerte</button>
        </div>

        <div class="tab-content">
            <!-- Team Rivalen -->
            <div class="tab-panel active" id="teamRivalen">
                <h4>Spieler des gleichen Vereins und Position</h4>
                <div style="overflow-x: auto;">
                    <table class="table" id="rivalenTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Marktwert</th>
                                <th>Punkte</th>
                                <th>Status</th>
                                <th>Besitzer</th>
                            </tr>
                        </thead>
                        <tbody id="rivalenTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Punktehistorie -->
            <div class="tab-panel" id="punktehistorie">
                <h4>Aktuelle Saison</h4>
                <div style="overflow-x: auto;">
                    <table class="table" id="saisonTable">
                        <thead>
                            <tr>
                                <th>Spieltag</th>
                                <th>Punkte</th>
                            </tr>
                        </thead>
                        <tbody id="saisonTableBody"></tbody>
                    </table>
                </div>

                <h4 style="margin-top: 30px;">Jahresübersicht</h4>
                <div style="overflow-x: auto;">
                    <table class="table" id="jahreTable">
                        <thead>
                            <tr>
                                <th>Jahr</th>
                                <th>Punkte</th>
                            </tr>
                        </thead>
                        <tbody id="jahreTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Marktwerte -->
            <div class="tab-panel" id="marktwerte">
                <h4>Marktwertentwicklung</h4>
                <div style="overflow-x: auto;">
                    <table class="table" id="marktwerteTable">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Marktwert</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="marktwerteTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen für die Daten
        let spielerDaten = [];
        let vereineDaten = [];
        let marktWerteDaten = [];
        let playerUserMap = {};
        let currentPlayerId = null;
        let currentUserMap = {};

        // Initialisierung
        async function initPlayer() {
            const urlParams = new URLSearchParams(window.location.search);
            currentPlayerId = urlParams.get('id');
            
            if (!currentPlayerId) {
                alert('Keine Spieler-ID gefunden!');
                return;
            }

            await loadData();
            displayPlayer();
        }

        // Daten laden
        async function loadData() {
            try {
                // Spielerdaten laden
                const spielerResponse = await fetch('SpielerdatenbankNeutralJson.txt');
                const spielerText = await spielerResponse.text();
                spielerDaten = spielerText.split('\n')
                    .filter(line => line.trim())
                    .map(line => JSON.parse(line));

                // Vereinsdaten laden
                const vereineResponse = await fetch('VereinsdatenbankJson.txt');
                vereineDaten = await vereineResponse.json();

                // Marktwertdaten laden
                const marktwerteResponse = await fetch('MarktwerteJson.txt');
                const marktwerteText = await marktwerteResponse.text();
                marktWerteDaten = marktwerteText.split('\n')
                    .filter(line => line.trim())
                    .map(line => JSON.parse(line));

                // Player-User-Map laden
                const userMapResponse = await fetch('PlayerToUserMap_884691.txt');
                const userMapText = await userMapResponse.text();
                const userMapArray = userMapText.split('\n')
                    .filter(line => line.trim())
                    .map(line => JSON.parse(line));
                
                // Array zu Objekt konvertieren
                userMapArray.forEach(item => {
                    Object.assign(currentUserMap, item);
                });

            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                alert('Fehler beim Laden der Daten!');
            }
        }

        // Spieler anzeigen
        function displayPlayer() {
            const player = spielerDaten.find(p => p.id === currentPlayerId);
            if (!player) {
                alert('Spieler nicht gefunden!');
                return;
            }

            const data = player.data;
            const verein = vereineDaten.find(v => v.id === data.verein);

            // Header
            document.getElementById('playerName').textContent = player.name;
            document.getElementById('teamLogo').textContent = verein ? verein.name.substring(0, 3).toUpperCase() : '???';
            
            // Status Icon
            const statusIcon = document.getElementById('statusIcon');
            const status = data.comunioStatus?.status || data.status?.status || 'UNBEKANNT';
            statusIcon.className = 'status-icon';
            if (status === 'AKTIV') statusIcon.classList.add('status-aktiv');
            else if (status === 'VERLETZT') statusIcon.classList.add('status-verletzt');
            else statusIcon.classList.add('status-nicht-in-liga');

            // Spielerinformationen
            const geburtsdatum = data.spielerDaten?.geburtstag || 'N/A';
            let altersText = geburtsdatum;
            if (geburtsdatum !== 'N/A' && geburtsdatum.includes('.')) {
                try {
                    const [tag, monat, jahr] = geburtsdatum.split('.');
                    const heute = new Date();
                    const geburtstag = new Date(jahr, monat - 1, tag);
                    const alter = Math.floor((heute - geburtstag) / (365.25 * 24 * 60 * 60 * 1000));
                    altersText = `${geburtsdatum} (${alter} Jahre)`;
                } catch (e) {
                    // Fallback bei Parsing-Fehlern
                }
            }

            document.getElementById('geburtstag').textContent = altersText;
            document.getElementById('groesse').textContent = data.spielerDaten?.groesse || 'N/A';
            document.getElementById('nationalitaet').textContent = data.spielerDaten?.nationalitaet || 'N/A';
            document.getElementById('position').textContent = data.spielerDaten?.hauptposition || 'N/A';
            document.getElementById('fuss').textContent = data.spielerDaten?.fuss || 'N/A';
            document.getElementById('trikotNummer').textContent = data.spielerDaten?.trikotNummer || 'N/A';

            // Comunio
            document.getElementById('comunioPosition').textContent = data.position || 'N/A';
            document.getElementById('marktwert').textContent = formatCurrency(data.wert);
            document.getElementById('punkteLetztesJahr').textContent = data.lastSeasonPoints || '0';
            
            const userId = currentUserMap[currentPlayerId];
            const besitzerText = userId === '1' ? 'Computer' : `User ${userId}`;
            document.getElementById('besitzer').textContent = besitzerText;

            // Status
            document.getElementById('statusText').textContent = status;
            document.getElementById('statusDetails').textContent = data.comunioStatus?.details || data.status?.details || '-';

            // Statistiken
            const stats = data.stats || {};
            document.getElementById('playedGames').textContent = stats.playedGames || '0';
            document.getElementById('totalGoals').textContent = stats.totalGoals || '0';
            document.getElementById('notenDurchschnitt').textContent = stats.notenDurchschnitt || '0';
            document.getElementById('gelbeKarten').textContent = stats.gelbekarten || '0';
            document.getElementById('roteKarten').textContent = stats.rotekarten || '0';

            // Attribute
            displayAttributes(data.attribute);

            // Tabs laden
            loadTeamRivalen(player);
            loadPunktehistorie(data.punkteHistorie);
            loadMarktwerte(player.id);
        }

        // Attribute anzeigen
        function displayAttributes(attributes) {
            const container = document.getElementById('attributeContainer');
            const card = document.getElementById('attributeCard');
            
            if (!attributes || attributes.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            container.innerHTML = '';

            attributes.forEach(attr => {
                if (typeof attr === 'object') {
                    Object.keys(attr).forEach(key => {
                        const div = document.createElement('div');
                        div.innerHTML = `<h4>${key}</h4>`;
                        
                        if (Array.isArray(attr[key])) {
                            const tags = document.createElement('div');
                            tags.className = 'attributes';
                            attr[key].forEach(value => {
                                const tag = document.createElement('span');
                                tag.className = 'attribute-tag';
                                tag.textContent = value;
                                tags.appendChild(tag);
                            });
                            div.appendChild(tags);
                        }
                        container.appendChild(div);
                    });
                }
            });
        }

        // Team-Rivalen laden
        function loadTeamRivalen(currentPlayer) {
            const verein = currentPlayer.data.verein;
            const position = currentPlayer.data.position;
            
            const rivalen = spielerDaten.filter(p => 
                p.data.verein === verein && 
                p.data.position === position
            );

            const tbody = document.getElementById('rivalenTableBody');
            tbody.innerHTML = '';

            rivalen.forEach(player => {
                const row = document.createElement('tr');
                const userId = currentUserMap[player.id];
                const isOwn = userId !== '1';
                const isCurrent = player.id === currentPlayerId;

                if (isCurrent) row.classList.add('player-current');
                else if (isOwn) row.classList.add('player-own');

                const besitzer = userId === '1' ? 'Computer' : `User ${userId}`;
                const status = player.data.comunioStatus?.status || player.data.status?.status || 'UNBEKANNT';

                row.innerHTML = `
                    <td>${player.name}</td>
                    <td>${formatCurrency(player.data.wert)}</td>
                    <td>${player.data.punkte || '0'}</td>
                    <td>${status}</td>
                    <td>${besitzer}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Punktehistorie laden
        function loadPunktehistorie(punkteHistorie) {
            if (!punkteHistorie) return;

            // Aktuelle Saison (Spieltage 1-34)
            const saisonPunkte = punkteHistorie.filter(p => p.key <= 34);
            const saisonTbody = document.getElementById('saisonTableBody');
            saisonTbody.innerHTML = '';

            saisonPunkte.forEach(punkt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>Spieltag ${punkt.key}</td>
                    <td>${punkt.value}</td>
                `;
                saisonTbody.appendChild(row);
            });

            // Jahre (key > 50)
            const jahresPunkte = punkteHistorie.filter(p => p.key > 50).sort((a, b) => b.key - a.key);
            const jahreTbody = document.getElementById('jahreTableBody');
            jahreTbody.innerHTML = '';

            jahresPunkte.forEach(punkt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${punkt.key}</td>
                    <td>${punkt.value}</td>
                `;
                jahreTbody.appendChild(row);
            });
        }

        // Marktwerte laden
        function loadMarktwerte(playerId) {
            const playerMarktwerte = marktWerteDaten.find(m => m.id === playerId);
            if (!playerMarktwerte || !playerMarktwerte.data?.normal) return;

            const werte = playerMarktwerte.data.normal.slice(0, 20); // Nur die letzten 20 Einträge
            const tbody = document.getElementById('marktwerteTableBody');
            tbody.innerHTML = '';

            werte.forEach((wert, index) => {
                const row = document.createElement('tr');
                let trendIcon = '';
                let trendClass = '';

                if (index < werte.length - 1) {
                    const nextWert = werte[index + 1];
                    if (wert.wert > nextWert.wert) {
                        trendIcon = '↗';
                        trendClass = 'trend-up';
                    } else if (wert.wert < nextWert.wert) {
                        trendIcon = '↘';
                        trendClass = 'trend-down';
                    } else {
                        trendIcon = '→';
                    }
                }

                row.innerHTML = `
                    <td>${formatDate(wert.date)}</td>
                    <td>${formatCurrency(wert.wert)}</td>
                    <td><span class="${trendClass}">${trendIcon}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Tab-Funktionalität
        function showTab(tabName) {
            // Alle Tabs deaktivieren
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

            // Gewählten Tab aktivieren
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Hilfsfunktionen
        function formatCurrency(value) {
            if (!value) return '0 €';
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatDate(dateString) {
            try {
                const [day, month, year] = dateString.split('.');
                return `${day}.${month}.${year}`;
            } catch (e) {
                return dateString;
            }
        }

        function goBack() {
            if (document.referrer) {
                window.history.back();
            } else {
                window.location.href = 'index.html'; // Fallback zur Hauptseite
            }
        }

        // Initialisierung beim Laden der Seite
        document.addEventListener('DOMContentLoaded', initPlayer);
    </script>
</body>
</html>
