<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚽ Comunio Ultraz - Spielerdatenbank</title>
    <style>
        /* Reset und Grundlagen */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2em;
            color: #7f8c8d;
        }

        /* Statistiken */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Debug-Bereich */
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-section h3 {
            color: #495057;
            margin-bottom: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .debug-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .debug-timestamp {
            color: #6c757d;
            font-size: 0.8em;
        }

        .debug-ok {
            color: #28a745;
            font-weight: bold;
        }

        .debug-error {
            color: #dc3545;
            font-weight: bold;
        }

        .debug-warn {
            color: #ffc107;
            font-weight: bold;
        }

        /* News Panel - Einklappbar */
        .news-panel {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .news-panel summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            user-select: none;
            list-style: none;
        }

        .news-panel summary::-webkit-details-marker {
            display: none;
        }

        .news-panel summary::before {
            content: "▼ ";
            transition: transform 0.3s ease;
        }

        .news-panel:not([open]) summary::before {
            transform: rotate(-90deg);
        }

        .news-content {
            padding: 20px;
        }

        .news-date {
            font-weight: bold;
            color: #495057;
            margin: 15px 0 8px 0;
            font-size: 1.1em;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 5px;
        }

        .news-type {
            font-weight: 600;
            color: #6c757d;
            margin: 10px 0 5px 0;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .news-item {
            margin-left: 20px;
            margin-bottom: 5px;
            padding: 5px 0;
            color: #495057;
            line-height: 1.4;
        }

        .news-item:before {
            content: "• ";
            color: #6c757d;
            font-weight: bold;
        }

        /* Filter Panel - Einklappbar */
        .filter-panel {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .filter-panel summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            user-select: none;
            list-style: none;
        }

        .filter-panel summary::-webkit-details-marker {
            display: none;
        }

        .filter-panel summary::before {
            content: "▼ ";
            transition: transform 0.3s ease;
        }

        .filter-panel:not([open]) summary::before {
            transform: rotate(-90deg);
        }

        .filter-content {
            padding: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .reset-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .reset-btn:hover {
            background: linear-gradient(135deg, #ff5252 0%, #e53e3e 100%);
            transform: translateY(-2px);
        }

        /* Tabelle */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:hover {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:nth-child(even):hover {
            background: #e9ecef;
        }

        /* Formatierung für Tabellenwerte */
        .value-high {
            color: #28a745;
            font-weight: bold;
        }

        .value-medium {
            color: #ffc107;
            font-weight: bold;
        }

        .value-low {
            color: #dc3545;
            font-weight: bold;
        }

        .points-high {
            color: #28a745;
            font-weight: bold;
        }

        .points-medium {
            color: #17a2b8;
            font-weight: bold;
        }

        .points-low {
            color: #6c757d;
        }

        .status-active {
            color: #28a745;
            font-weight: bold;
        }

        .status-injured {
            color: #dc3545;
            font-weight: bold;
        }

        .status-training {
            color: #ffc107;
            font-weight: bold;
        }

        .status-suspended {
            color: #6f42c1;
            font-weight: bold;
        }

        .status-not-in-league {
            color: #6c757d;
            font-style: italic;
        }

        /* Loading und Error States */
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.1em;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .reload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .reload-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }

        /* Sortierung Pfeile */
        .sort-arrow {
            margin-left: 8px;
            opacity: 0.5;
        }

        .sort-arrow.active {
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px 6px;
            }
        }

        /* Animationen */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>⚽ Comunio Ultraz - Spielerdatenbank</h1>
            <p>Live-Marktwerte, Punkte & News aus der Community</p>
        </div>

        <!-- Statistiken -->
        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <h3 id="totalPlayers">---</h3>
                <p>Gesamt Spieler</p>
            </div>
            <div class="stat-card">
                <h3 id="filteredPlayers">---</h3>
                <p>Gefilterte Spieler</p>
            </div>
            <div class="stat-card">
                <h3 id="totalValue">---</h3>
                <p>Gesamtwert (Filter)</p>
            </div>
            <div class="stat-card">
                <h3 id="avgValue">---</h3>
                <p>Durchschnittswert</p>
            </div>
        </div>

        <!-- Debug-Bereich -->
        <div class="debug-section" id="debugSection">
            <h3>🔧 Debug-Informationen</h3>
            <div id="debugContent">
                <div class="debug-entry">
                    <span class="debug-timestamp">[INIT]</span> <span class="debug-ok">Initialisierung gestartet...</span>
                </div>
            </div>
        </div>

        <!-- News Panel -->
        <details class="news-panel" id="newsPanel" open>
            <summary>📰 Aktuelle News</summary>
            <div class="news-content" id="newsContent">
                <div class="loading">News werden geladen...</div>
            </div>
        </details>

        <!-- Filter Panel -->
        <details class="filter-panel" open>
            <summary>🔍 Filter & Suche</summary>
            <div class="filter-content" id="filterContent">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="searchPlayer">🔍 Spieler suchen:</label>
                        <input type="text" id="searchPlayer" placeholder="Name eingeben...">
                    </div>
                    <div class="filter-group">
                        <label for="filterPosition">📍 Position:</label>
                        <select id="filterPosition">
                            <option value="">Alle Positionen</option>
                            <option value="TORHÜTER">Torhüter</option>
                            <option value="ABWEHR">Abwehr</option>
                            <option value="MITTELFELD">Mittelfeld</option>
                            <option value="STURM">Sturm</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">💪 Status:</label>
                        <select id="filterStatus">
                            <option value="">Alle Status</option>
                            <option value="AKTIV">Aktiv</option>
                            <option value="VERLETZT">Verletzt</option>
                            <option value="AUFBAUTRAINING">Aufbautraining</option>
                            <option value="NICHT_IM_KADER">Nicht im Kader</option>
                            <option value="5_GELBE_KARTE">5. gelbe Karte</option>
                            <option value="GELBROTE_KARTE">Gelbrote Karte</option>
                            <option value="ROTE_KARTE">Rote Karte</option>
                            <option value="NICHT_IN_LIGA">Nicht in Liga</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterClub">🏟️ Verein:</label>
                        <select id="filterClub">
                            <option value="">Alle Vereine</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterOwner">👤 Besitzer:</label>
                        <select id="filterOwner">
                            <option value="">Alle Besitzer</option>
                            <option value="NONE">Kein Besitzer</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="hideNotInLeague">
                            <label for="hideNotInLeague">Nicht-in-Liga-Spieler ausblenden</label>
                        </div>
                        <button class="reset-btn" onclick="resetFilters()">Filter zurücksetzen</button>
                    </div>
                </div>
            </div>
        </details>

        <!-- Tabelle -->
        <div class="table-container">
            <div class="table-responsive">
                <table id="playerTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('name')">Spieler <span class="sort-arrow" id="sort-name">↕</span></th>
                            <th onclick="sortTable('club')">Verein <span class="sort-arrow" id="sort-club">↕</span></th>
                            <th onclick="sortTable('position')">Position <span class="sort-arrow" id="sort-position">↕</span></th>
                            <th onclick="sortTable('status')">Status <span class="sort-arrow" id="sort-status">↕</span></th>
                            <th onclick="sortTable('value')">Marktwert <span class="sort-arrow" id="sort-value">↕</span></th>
                            <th onclick="sortTable('points')">Punkte <span class="sort-arrow" id="sort-points">↕</span></th>
                            <th onclick="sortTable('owner')">Besitzer <span class="sort-arrow" id="sort-owner">↕</span></th>
                            <th onclick="sortTable('updated')">Letztes Update <span class="sort-arrow" id="sort-updated">↕</span></th>
                        </tr>
                    </thead>
                    <tbody id="playerTableBody">
                        <tr>
                            <td colspan="8" class="loading">📡 Lade aktuelle Spielerdaten...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Error/Reload Section -->
        <div id="errorSection" style="display: none;">
            <div class="error">
                <strong>Fehler beim Laden der Daten.</strong>
                <button class="reload-btn" onclick="loadData()">🔄 Daten neu laden</button>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let allPlayers = [];
        let filteredPlayers = [];
        let currentSort = { field: 'name', direction: 'asc' };
        let isLoading = false;

        // Debug-Funktionen - Frühe Ausgabe
        function debugLog(message, data = null, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const debugContent = document.getElementById('debugContent');
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            
            let typeClass = 'debug-ok';
            if (type === 'error') typeClass = 'debug-error';
            if (type === 'warn') typeClass = 'debug-warn';
            
            entry.innerHTML = `<span class="debug-timestamp">[${timestamp}]</span> <span class="${typeClass}">${message}</span>`;
            
            if (data) {
                entry.innerHTML += `<br><pre style="font-size: 0.8em; color: #6c757d;">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            debugContent.appendChild(entry);
            debugContent.scrollTop = debugContent.scrollHeight;
            
            // Maximal 50 Debug-Einträge behalten
            while (debugContent.children.length > 50) {
                debugContent.removeChild(debugContent.firstChild);
            }
        }

        // Sofortige Debug-Ausgabe beim Laden
        debugLog('🚀 Script geladen, starte Initialisierung');

        // Daten laden
        async function loadData() {
            if (isLoading) {
                debugLog('⏳ Laden bereits in Gange, überspringe...', null, 'warn');
                return;
            }
            
            isLoading = true;
            debugLog('📊 Starte Datenladefunktion');
            
            try {
                await Promise.all([
                    loadPlayerData(),
                    loadNewsData()
                ]);
                debugLog('✅ Alle Daten erfolgreich geladen');
            } catch (error) {
                debugLog('❌ Fehler beim Laden der Daten', error, 'error');
                showError();
            } finally {
                isLoading = false;
            }
        }

        // Spielerdaten laden
        async function loadPlayerData() {
            debugLog('📥 Lade Spielerdaten von API/Datei...');
            
            try {
                // Hier deine echte API-URL oder Datei-URL einsetzen
                const response = await fetch('/api/players.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                allPlayers = data;
                
                debugLog(`✅ ${allPlayers.length} Spieler geladen`);
                
                // Filter aufbauen
                buildFilters();
                
                // Initiale Filterung
                applyFilters();
                
                // Tabelle rendern
                renderTable();
                
                // Statistiken aktualisieren
                updateStats();
                
            } catch (error) {
                debugLog('❌ Fehler beim Laden der Spielerdaten', error, 'error');
                // Fallback: Versuche lokale Datei
                try {
                    const response = await fetch('data/players.json');
                    if (response.ok) {
                        const data = await response.json();
                        allPlayers = data;
                        debugLog(`✅ Fallback: ${allPlayers.length} Spieler aus lokaler Datei geladen`);
                        buildFilters();
                        applyFilters();
                        renderTable();
                        updateStats();
                    } else {
                        throw new Error('Auch lokale Datei nicht verfügbar');
                    }
                } catch (fallbackError) {
                    debugLog('❌ Auch Fallback fehlgeschlagen', fallbackError, 'error');
                    showError();
                }
            }
        }

        // News laden
        async function loadNewsData() {
            debugLog('📰 Lade News-Daten...');
            
            try {
                const response = await fetch('/api/news.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const newsData = await response.json();
                debugLog(`✅ ${newsData.length} News-Einträge geladen`);
                
                renderNews(newsData);
                
            } catch (error) {
                debugLog('❌ Fehler beim Laden der News', error, 'error');
                // Fallback: Versuche lokale Datei
                try {
                    const response = await fetch('data/news.json');
                    if (response.ok) {
                        const newsData = await response.json();
                        debugLog(`✅ Fallback: ${newsData.length} News aus lokaler Datei geladen`);
                        renderNews(newsData);
                    } else {
                        document.getElementById('newsContent').innerHTML = '<div class="error">News konnten nicht geladen werden</div>';
                    }
                } catch (fallbackError) {
                    debugLog('❌ News-Fallback fehlgeschlagen', fallbackError, 'error');
                    document.getElementById('newsContent').innerHTML = '<div class="error">News nicht verfügbar</div>';
                }
            }
        }

        // Filter aufbauen - FIX: Alle Vereine und Besitzer
        function buildFilters() {
            debugLog('🔧 Baue Filter auf...');
            
            // Vereine - aus allen Spielern extrahieren
            const clubs = [...new Set(allPlayers.map(p => p.club).filter(club => club))].sort();
            const clubSelect = document.getElementById('filterClub');
            clubSelect.innerHTML = '<option value="">Alle Vereine</option>';
            clubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club;
                option.textContent = club;
                clubSelect.appendChild(option);
            });
            
            // Besitzer - aus allen Spielern extrahieren
            const owners = [...new Set(allPlayers.map(p => p.owner).filter(owner => owner))].sort();
            const ownerSelect = document.getElementById('filterOwner');
            ownerSelect.innerHTML = '<option value="">Alle Besitzer</option><option value="NONE">Kein Besitzer</option>';
            owners.forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                ownerSelect.appendChild(option);
            });
            
            debugLog(`✅ Filter aufgebaut: ${clubs.length} Vereine, ${owners.length} Besitzer`);
        }

        // Filter anwenden
        function applyFilters() {
            debugLog('🔍 Wende Filter an...');
            
            const searchTerm = document.getElementById('searchPlayer').value.toLowerCase();
            const positionFilter = document.getElementById('filterPosition').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const clubFilter = document.getElementById('filterClub').value;
            const ownerFilter = document.getElementById('filterOwner').value;
            const hideNotInLeague = document.getElementById('hideNotInLeague').checked;
            
            filteredPlayers = allPlayers.filter(player => {
                // Namenssuche
                if (searchTerm && !player.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Position
                if (positionFilter && player.position !== positionFilter) {
                    return false;
                }
                
                // Status
                if (statusFilter && player.status !== statusFilter) {
                    return false;
                }
                
                // Verein
                if (clubFilter && player.club !== clubFilter) {
                    return false;
                }
                
                // Besitzer
                if (ownerFilter === 'NONE' && player.owner) {
                    return false;
                }
                if (ownerFilter && ownerFilter !== 'NONE' && player.owner !== ownerFilter) {
                    return false;
                }
                
                // Nicht-in-Liga ausblenden
                if (hideNotInLeague && player.status === 'NICHT_IN_LIGA') {
                    return false;
                }
                
                return true;
            });
            
            debugLog(`✅ Filter angewendet: ${filteredPlayers.length} von ${allPlayers.length} Spielern`);
            
            renderTable();
            updateStats();
        }

        // Tabelle rendern - FIX: Originalformatierung
        function renderTable() {
            debugLog('🔄 Rendere Tabelle...');
            
            const tbody = document.getElementById('playerTableBody');
            
            if (filteredPlayers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Keine Spieler gefunden</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredPlayers.map(player => {
                return `
                    <tr>
                        <td>${player.name}</td>
                        <td>${player.club}</td>
                        <td>${player.position}</td>
                        <td class="${getStatusClass(player.status)}">${formatStatus(player.status)}</td>
                        <td class="${getValueClass(player.value)}">${formatValue(player.value)}</td>
                        <td class="${getPointsClass(player.points)}">${player.points}</td>
                        <td>${player.owner || '-'}</td>
                        <td>${formatDate(player.updated)}</td>
                    </tr>
                `;
            }).join('');
            
            // Sortierung anwenden
            if (currentSort.field) {
                updateSortIndicators();
            }
        }

        // News rendern - mit Datum/Typ Sortierung
        function renderNews(newsData) {
            debugLog('📰 Rendere News...');
            
            const newsContent = document.getElementById('newsContent');
            
            if (!newsData || newsData.length === 0) {
                newsContent.innerHTML = '<div class="loading">Keine News verfügbar</div>';
                return;
            }
            
            // Sortiere News nach Datum (neueste zuerst)
            newsData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            newsContent.innerHTML = newsData.map(dateGroup => {
                const formattedDate = formatDate(dateGroup.date);
                
                // Gruppiere News nach Typ
                const groupedByType = dateGroup.items.reduce((acc, item) => {
                    if (!acc[item.type]) {
                        acc[item.type] = [];
                    }
                    acc[item.type].push(item.msg);
                    return acc;
                }, {});
                
                return `
                    <div class="news-date">${formattedDate}</div>
                    ${Object.entries(groupedByType).map(([type, messages]) => `
                        <div class="news-type">${type}</div>
                        ${messages.map(msg => `<div class="news-item">${msg}</div>`).join('')}
                    `).join('')}
                `;
            }).join('');
        }

        // Statistiken aktualisieren
        function updateStats() {
            debugLog('📊 Aktualisiere Statistiken...');
            
            document.getElementById('totalPlayers').textContent = allPlayers.length.toLocaleString();
            document.getElementById('filteredPlayers').textContent = filteredPlayers.length.toLocaleString();
            
            const totalValue = filteredPlayers.reduce((sum, p) => sum + p.value, 0);
            document.getElementById('totalValue').textContent = formatValue(totalValue);
            
            const avgValue = filteredPlayers.length > 0 ? totalValue / filteredPlayers.length : 0;
            document.getElementById('avgValue').textContent = formatValue(avgValue);
        }

        // Sortierung
        function sortTable(field) {
            debugLog(`🔄 Sortiere nach ${field}`);
            
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            filteredPlayers.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Spezielle Behandlung für verschiedene Datentypen
                if (field === 'value' || field === 'points') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (field === 'updated') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }
                
                let result = 0;
                if (aVal < bVal) result = -1;
                if (aVal > bVal) result = 1;
                
                return currentSort.direction === 'asc' ? result : -result;
            });
            
            renderTable();
            updateSortIndicators();
        }

        // Sortierung-Indikatoren aktualisieren
        function updateSortIndicators() {
            // Alle Pfeile zurücksetzen
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.classList.remove('active');
                arrow.textContent = '↕';
            });
            
            // Aktiven Pfeil setzen
            const activeArrow = document.getElementById(`sort-${currentSort.field}`);
            if (activeArrow) {
                activeArrow.classList.add('active');
                activeArrow.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
            }
        }

        // Filter zurücksetzen
        function resetFilters() {
            debugLog('🔄 Setze Filter zurück');
            
            document.getElementById('searchPlayer').value = '';
            document.getElementById('filterPosition').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterClub').value = '';
            document.getElementById('filterOwner').value = '';
            document.getElementById('hideNotInLeague').checked = false;
            
            applyFilters();
        }

        // Hilfsfunktionen für Formatierung - FIX: Originalformatierung
        function formatValue(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + ' Mio €';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(0) + ' T €';
            } else {
                return value.toLocaleString() + ' €';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatStatus(status) {
            const statusMap = {
                'AKTIV': 'Aktiv',
                'VERLETZT': 'Verletzt',
                'AUFBAUTRAINING': 'Aufbautraining',
                'NICHT_IM_KADER': 'Nicht im Kader',
                '5_GELBE_KARTE': '5. gelbe Karte',
                'GELBROTE_KARTE': 'Gelbrote Karte',
                'ROTE_KARTE': 'Rote Karte',
                'NICHT_IN_LIGA': 'Nicht in Liga'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            if (status === 'AKTIV') return 'status-active';
            if (status === 'VERLETZT') return 'status-injured';
            if (status === 'AUFBAUTRAINING') return 'status-training';
            if (status.includes('KARTE') || status.includes('GELB') || status.includes('ROT')) return 'status-suspended';
            if (status === 'NICHT_IN_LIGA') return 'status-not-in-league';
            return '';
        }

        function getValueClass(value) {
            if (value >= 10000000) return 'value-high';
            if (value >= 5000000) return 'value-medium';
            if (value < 2000000) return 'value-low';
            return '';
        }

        function getPointsClass(points) {
            if (points >= 70) return 'points-high';
            if (points >= 40) return 'points-medium';
            if (points < 20) return 'points-low';
            return '';
        }

        // Fehler anzeigen
        function showError() {
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('playerTableBody').innerHTML = '<tr><td colspan="8" class="error">Fehler beim Laden der Daten.</td></tr>';
        }

        // Event Listeners
        document.getElementById('searchPlayer').addEventListener('input', applyFilters);
        document.getElementById('filterPosition').addEventListener('change', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterClub').addEventListener('change', applyFilters);
        document.getElementById('filterOwner').addEventListener('change', applyFilters);
        document.getElementById('hideNotInLeague').addEventListener('change', applyFilters);

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('✅ DOM geladen, starte Hauptfunktionen');
            loadData();
        });

        // Periodic Update alle 5 Minuten
        setInterval(() => {
            debugLog('🔄 Automatisches Update gestartet');
            loadData();
        }, 300000);

        // Gleich bei Script-Start debuggen
        debugLog('🔧 Event-Listener registriert');
    </script>
</body>
</html>
