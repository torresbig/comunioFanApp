<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>⚽ Comunio Ultraz - Spielerdatenbank</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
        }

        /* Floating debug panel styles */
        #floatingDebugBtn {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1001;
            background: #3498dbcc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            opacity: 0.5;
            transition: opacity 0.2s, background 0.2s;
        }

        #floatingDebugBtn:hover {
            opacity: 1;
            background: #217dbbcc;
        }

        #floatingDebugPanel {
            position: fixed;
            top: 58px;
            right: 12px;
            width: 260px;
            max-height: 260px;
            background: #f0f8ff;
            border: 1px solid #cce;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.10);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        #floatingDebugPanel.open {
            display: flex;
        }

        #floatingDebugPanelHeader {
            background: #3498db;
            color: white;
            padding: 7px 12px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #floatingDebugPanelClose {
            background: none;
            border: none;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            margin-left: 8px;
        }

        #floatingDebugContent {
            padding: 8px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.4;
            overflow-y: auto;
            background: #f0f8ff;
            border-radius: 0 0 8px 8px;
            flex: 1;
        }

        #floatingDebugPanel {
            position: fixed;
            top: 54px;
            right: 18px;
            width: 340px;
            max-height: 400px;
            background: #f0f8ff;
            border: 1px solid #cce;
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        #floatingDebugPanel.open {
            display: flex;
        }

        #floatingDebugPanelHeader {
            background: #3498db;
            color: white;
            padding: 10px 16px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #floatingDebugPanelClose {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }

        #floatingDebugContent {
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
            overflow-y: auto;
            background: #f0f8ff;
            border-radius: 0 0 8px 8px;
            flex: 1;
        }

        .toggle-label {
            background: #3498db;
            color: white;
            padding: 12px 16px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            margin: 24px 0 0 0;
            display: block;
            font-size: 13px;
            position: relative;
        }

        .toggle-label::before {
            content: '▶ ';
            transition: transform 0.3s ease;
            display: inline-block;
            width: 20px;
        }

        .toggle-toggle:checked+.toggle-label::before {
            transform: rotate(90deg);
        }

        .toggle-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            background: #f0f8ff;
            border: 1px solid #cce;
            border-top: none;
            border-radius: 0 0 6px 6px;
            margin-top: 0;
        }

        .toggle-toggle:checked+.toggle-label+.toggle-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .toggle-inner {
            padding: 15px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.5;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
        }

        .stats {
            background: #e8f5e8;
            border: 1px solid #c5e6c5;
            color: #2e7d2e;
            text-align: center;
        }

        .update-info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            font-size: 12px;
            text-align: center;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .filter-table-gap {
            height: 20px;
        }

        .filter-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 13px;
        }

        input,
        select,
        button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .reset-button {
            background-color: #5c6bc0;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 12px;
            transition: background 0.3s;
        }

        .reset-button:hover {
            background-color: #3f51b5;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th,
        td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        th {
            background-color: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: #34495e;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f7ff;
            cursor: pointer;
        }

        .status-aktiv {
            color: #27ae60;
            font-weight: bold;
        }

        .status-verletzt {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-gesperrt {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-reha {
            color: #f39c12;
            font-weight: bold;
        }

        .status-nichtliga {
            color: #7f8c8d;
            font-style: italic;
        }

        .club-logo {
            width: 25px;
            height: 25px;
            object-fit: contain;
            margin-right: 10px;
            vertical-align: middle;
        }

        .debug-toggle {
            display: none;
        }

        .debug-label {
            background: #3498db;
            color: white;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            margin: 15px 0;
            display: block;
        }

        .debug-label::before {
            content: '▶ ';
            transition: transform 0.3s ease;
            display: inline-block;
            width: 20px;
        }

        .debug-toggle:checked+.debug-label::before {
            transform: rotate(90deg);
        }

        .debug-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            background: #f0f8ff;
            border: 1px solid #cce;
            border-radius: 0 0 6px 6px;
            margin-top: -5px;
        }

        .debug-toggle:checked+.debug-label+.debug-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-inner {
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        #news-section {
            margin-bottom: 24px;
        }

        #news-section .header {
            display: flex;
            align-items: center;
            cursor: pointer;
            background: #f5f5f5;
            border-radius: 6px 6px 0 0;
            padding: 12px 16px;
            user-select: none;
            border-bottom: 1px solid #e0e0e0;
        }

        #news-section .header span:first-child {
            font-size: 1.18em;
            font-weight: bold;
            letter-spacing: 1px;
            flex: 1;
            color: #222;
        }

        #news-toggle-icon {
            font-size: 1.2em;
            transition: transform 0.2s;
        }

        #news-list {
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            background: #fff;
            max-height: 420px;
            overflow-y: auto;
            transition: max-height 0.3s;
        }

        .news-day {
            margin-bottom: 18px;
        }

        .news-date {
            font-weight: bold;
            font-size: 1.08em;
            color: #1976d2;
            margin-bottom: 4px;
        }

        .news-art {
            font-weight: 500;
            color: #555;
            margin: 6px 0 2px 0;
        }

        .news-list-ul {
            list-style: none;
            margin: 0 0 8px 0;
            padding: 0;
        }

        .news-list-li {
            padding: 4px 0 4px 12px;
            border-left: 2px solid #e0e0e0;
        }

        @media (max-width: 600px) {
            .filters {
                grid-template-columns: 1fr !important;
                gap: 10px;
                padding: 12px;
            }

            .filter-group,
            .checkbox-group {
                margin-bottom: 0;
            }

            #filterContentWrapper {
                max-height: 80vh;
                /* 80% der Bildschirmhöhe für mehr Platz */
                overflow-y: auto !important;
                /* Scrollbar ermöglichen */
                /* Optional zur Verbesserung des Scrollverhaltens auf iOS-Geräten: */
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>⚽ Comunio Ultraz - Spielerdatenbank</h1>
            <p class="subtitle">Fußballspieler Daten • Live von GitHub</p>
        </header>
        <div id="loading" class="loading">
            <p>📡 Lade aktuelle Spielerdaten...</p>
        </div>
        <div id="error" class="error" style="display: none;">
            <p id="errorMessage">Fehler beim Laden der Daten.</p>
        </div>
        <div id="updateInfo" class="update-info" style="display: none;">
            <span id="updateText"></span>
        </div>
        <div id="stats" class="stats" style="display: none;">
            <span id="statsText"></span>
            <button id="refreshButton" class="refresh-button">🔄 Daten neu laden</button>
        </div>
        <!-- Floating Debug Button and Panel -->
        <button id="floatingDebugBtn" title="Debug"><span style="pointer-events:none;">🐞</span></button>
        <div id="floatingDebugPanel">
            <div id="floatingDebugPanelHeader">
                Debug-Informationen
                <button id="floatingDebugPanelClose" title="Schließen">×</button>
            </div>
            <div id="floatingDebugContent"></div>
        </div>
        <div id="news-section">
            <label class="toggle-label" id="newsLabel">Comunio-News</label>
            <div class="toggle-content" id="newsContentWrapper">
                <div class="toggle-inner" id="news-list">
                    <div style="padding: 16px; color: #888;">Lade Comunio-News...</div>
                </div>
            </div>
        </div>
        <div id="content" style="display: none;">
            <label class="toggle-label" id="filterLabel">Filter</label>
            <div class="toggle-content" id="filterContentWrapper">
                <div class="toggle-inner">
                    <div class="filters">
                        <div class="filter-group">
                            <label for="search">🔍 Spieler suchen:</label>
                            <input type="text" id="search" placeholder="Name oder ID...">
                        </div>
                        <div class="filter-group">
                            <label for="position">📍 Position:</label>
                            <select id="position">
                                <option value="">Alle Positionen</option>
                                <option value="TORHÜTER">Torhüter</option>
                                <option value="ABWEHR">Abwehr</option>
                                <option value="MITTELFELD">Mittelfeld</option>
                                <option value="STURM">Sturm</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="status">💪 Status:</label>
                            <select id="status">
                                <option value="">Alle Status</option>
                                <option value="AKTIV">Aktiv</option>
                                <option value="VERLETZT">Verletzt</option>
                                <option value="AUFBAUTRAINING">Aufbautraining</option>
                                <option value="NICHT_IM_KADER">Nicht im Kader</option>
                                <option value="FUENFTE_GELBE_KARTE">5. gelbe Karte</option>
                                <option value="GELBROTE_KARTE">Gelbrote Karte</option>
                                <option value="ROTE_KARTE">Rote Karte</option>
                                <option value="NICHT_IN_LIGA">Nicht in Liga</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="club">🏟️ Verein:</label>
                            <select id="club">
                                <option value="">Alle Vereine</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="owner">👤 Besitzer:</label>
                            <select id="owner">
                                <option value="">Alle Besitzer</option>
                                <option value="Kein Besitzer">Kein Besitzer</option>
                            </select>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="hideNonLeague" checked>
                            <label for="hideNonLeague">Nicht-in-Liga-Spieler ausblenden</label>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 15px 0;">
                        <button type="button" class="reset-button" id="resetFilters">Filter zurücksetzen</button>
                    </div>
                </div>
            </div>
            <div class="filter-table-gap"></div>
            <div class="table-container">
                <table id="playerTable">
                    <thead>
                        <tr>
                            <th data-sort="string">Spieler</th>
                            <th data-sort="string">Verein</th>
                            <th data-sort="string">Position</th>
                            <th data-sort="string">Status</th>
                            <th data-sort="value">Marktwert</th>
                            <th data-sort="number">Punkte</th>
                            <th data-sort="string">Besitzer</th>
                            <th data-sort="string">Letztes Update</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>


        const GITHUB_USER = "torresbig";
        const GITHUB_REPO = "comunioFanApp";
        const DATA_URLS = {
            clubs: `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/VereinsdatenbankJson.txt`,
            players: `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/SpielerdatenbankNeutralJson.txt`,
            users: `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/UserdatenbankJson_884691.txt`,
            playerToUser: `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/PlayerToUserMap_884691.txt`,
            news: `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/News.json`
        };

        function toggleNewsList() {
            const list = document.getElementById('news-list');
            const icon = document.getElementById('news-toggle-icon');
            if (list.style.display === 'none') {
                list.style.display = '';
                icon.style.transform = 'rotate(0deg)';
            } else {
                list.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        function renderNews(newsList) {
            try {
                // Nach Datum absteigend sortieren (neueste zuerst!)
                newsList.sort((a, b) => {
                    const da = a.date.split('.').reverse().join('-');
                    const db = b.date.split('.').reverse().join('-');
                    return new Date(db) - new Date(da);
                });
                let html = '';
                for (const day of newsList) {
                    const grouped = {};
                    for (const news of day.news) {
                        if (!grouped[news.art]) grouped[news.art] = [];
                        grouped[news.art].push(news);
                    }
                    html += `<div class=\"news-day\"><div class=\"news-date\">${day.date}</div>`;
                    for (const art of Object.keys(grouped).sort()) {
                        html += `<div class=\"news-art\">${art}</div>
              <ul class=\"news-list-ul\">`;
                        for (const news of grouped[art]) {
                            let text = '';
                            try {
                                if (art === 'TRANSFER') {
                                    const obj = JSON.parse(news.text);
                                    text = `<span style="color:#80f;"><b>${obj.playerName}</b></span> von <b style="color:#00f;">${obj.seller}</b> zu <b style="color:#00f;">${obj.buyer}</b> für <b>${obj.price.toLocaleString('de-DE')} €</b> (Marktwert: ${obj.playerValue.toLocaleString('de-DE')} €)`;
                                } else if (art === 'SPIELERSTATUS') {
                                    const regex = /Statuswechsel:\s(.+?)\s\(\d+\)\sist\s(wieder|jetzt)\s([A-Z_]+)(?:\s\((.+)\))?/i;
                                    const match = regex.exec(news.text);

                                    if (match) {
                                        const playerName = match[1];
                                        const status = match[3];
                                        const statusDetail = match[4] || '';

                                        let statusDisplay = `<b>${status.replace(/_/g, ' ')}</b>`;

                                        if (statusDetail) {
                                            statusDisplay += ` (${statusDetail})`;
                                        }

                                        text = `Statusänderung: <span style="color:#80f;"><b>${playerName}</b></span> ist ${match[2]} ${statusDisplay}`;
                                    } else {
                                        text = news.text;
                                    }
                                } else if (art === 'VEREINSWECHSEL') {
                                    
                                        try {
                                            // Versuch, text als JSON zu parsen (neues Format)
                                            const obj = JSON.parse(news.text);

                                            // Falls erfolgreich, strukturierte Ausgabe
                                            text = `<span style="color:#80f;"><b>${obj.playerName}</b></span> wechselt von <b>${obj.oldClub}</b> zu <b>${obj.newClub}</b>`;
                                        } catch (e) {
                                            // Fallback, falls text kein JSON ist (altes Format)
                                            text = news.text;
                                        }
                                    

                                } else if (art === 'OWNERCHANGE') {
                                    
                                        try {
                                            // Versuch, text als JSON zu parsen (neues Format)
                                            const obj = JSON.parse(news.text);

                                            // Falls erfolgreich, strukturierte Ausgabe
                                           //text =`<span style="color:#80f;"><b>${obj.playerName}</b></span> war noch keine User zugeordnet! jetzt --> <b>${obj.buyer}</b> `;
                                        } catch (e) {
                                            // Fallback, falls text kein JSON ist (altes Format)
                                            text = news.text;
                                        }
                                    

                                } else {
                                    // Für andere Arten einfach den Text übernehmen
                                    text = news.text;
                                }
                            } catch (e) {
                                console.error("Fehler beim Verarbeiten des News-Textes:", news.text, e);
                                text = news.text;
                            }
                            html += `<li class=\"news-list-li\">${text}</li>`;
                        }
                        html += `</ul>`;
                    }
                    html += `</div>`;
                }
                document.getElementById('news-list').innerHTML = html || '<div style=\"padding:16px; color:#888;\">Keine News vorhanden.</div>';
            } catch {
                document.getElementById('news-list').innerHTML = '<div style=\"padding:16px; color:#e53935;\">Fehler beim Laden der News.</div>';
            }
            document.getElementById('news-list').style.display = '';
        }



        function getLogoFileName(clubId) {
            if (!clubId) return "unbestimmt.png";
            const mapping = {
                "3": "gladbach",
                "21": "freiburg",
                "18": "mainz",
                "92": "leipzig",
                "1": "bayern",
                "6": "werderBremen",
                "12": "wolfsburg",
                "5": "dortmund",
                "8": "leverkusen",
                "13": "koeln",
                "14": "stuttgart",
                "62": "hoffenheim",
                "68": "augsburg",
                "9": "frankfurt",
                "109": "unionBerlin",
                "110": "heidenheim",
                "25": "stpauli",
                "4": "hamburg",
            };
            return (mapping[clubId] || "unbestimmt") + ".png";
        }

        let allPlayers = [];
        let clubsMap = new Map();
        let ownersMap = new Map();
        let filteredPlayers = [];
        let lastUpdateTime = null;

        function addDebug(message) {
            const debugDiv = document.getElementById('floatingDebugContent');
            debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                addDebug("Seite geladen, starte Datenladevorgang...");
                await loadData();
                setupSorting();
            } catch (error) {
                showError("Laden fehlgeschlagen: " + error.message);
                addDebug("Fehler beim Laden: " + error.message);
            }
            document.getElementById('refreshButton').addEventListener('click', async () => {
                try {
                    addDebug("Manuelles Neuladen gestartet...");
                    await loadData();
                } catch (error) {
                    showError("Neuladen fehlgeschlagen: " + error.message);
                    addDebug("Fehler beim Neuladen: " + error.message);
                }
            });
            document.getElementById('hideNonLeague').addEventListener('change', applyFilters);

            // Floating debug panel logic
            const debugBtn = document.getElementById('floatingDebugBtn');
            const debugPanel = document.getElementById('floatingDebugPanel');
            const debugClose = document.getElementById('floatingDebugPanelClose');
            debugBtn.addEventListener('click', () => {
                debugPanel.classList.toggle('open');
            });
            debugClose.addEventListener('click', () => {
                debugPanel.classList.remove('open');
            });

            // Toggle-Menü-Logik
            function setupToggle(labelId, contentId) {
                const label = document.getElementById(labelId);
                const content = document.getElementById(contentId);
                let open = false;
                function update() {
                    let maxHeight = '300px';
                    if (labelId === 'newsLabel') maxHeight = '600px';
                    if (open) {
                        content.style.maxHeight = maxHeight;
                        label.classList.add('open');
                    } else {
                        content.style.maxHeight = '0';
                        label.classList.remove('open');
                    }
                }
                label.addEventListener('click', () => {
                    open = !open;
                    update();
                });
                update();
            }
            setupToggle('newsLabel', 'newsContentWrapper');
            setupToggle('filterLabel', 'filterContentWrapper');
        });

        async function loadData() {
            try {
                showLoading();
                addDebug("Starte Ladevorgang...");
                addDebug(`Lade URLs:
                    Clubs: ${DATA_URLS.clubs}
                    Players: ${DATA_URLS.players}
                    Users: ${DATA_URLS.users}
                    PlayerToUser: ${DATA_URLS.playerToUser}
                    News: ${DATA_URLS.news}`);
                const [clubsData, playersData, usersData, playerToUserMap, newsList] = await Promise.all([
                    fetchJSON(DATA_URLS.clubs),
                    fetchJSON(DATA_URLS.players),
                    fetchJSON(DATA_URLS.users),
                    fetchJSON(DATA_URLS.playerToUser),
                    fetchJSON(DATA_URLS.news)
                ]);

                addDebug("Daten erfolgreich geladen, verarbeite...");
                addDebug(`Daten empfangen:
                    Clubs: ${clubsData.length}
                    Players: ${playersData.length}
                    Users: ${usersData.length}
                    PlayerToUser: ${playerToUserMap.length}
                    News: ${newsList.length}`);
                processData(clubsData, playersData, usersData, playerToUserMap);
                renderNews(newsList);
                lastUpdateTime = new Date();
                hideLoading();
                showStats();
                showContent();
                setupEventListeners();
                applyFilters();
                addDebug("Datenverarbeitung abgeschlossen.");
            } catch (error) {
                hideLoading();
                addDebug("Fehler beim Laden: " + error.message);
                throw error;
            }
        }

        async function fetchJSON(url) {
            addDebug(`Lade Datei: ${url}`);
            const cacheBusterUrl = url + '?t=' + new Date().getTime();
            try {
                const response = await fetch(cacheBusterUrl);
                if (!response.ok) {
                    addDebug(`Fehler beim Laden: HTTP ${response.status}`);
                    throw new Error(`HTTP ${response.status} für ${url}`);
                }
                const text = await response.text();
                if (!text.trim()) {
                    addDebug("Warnung: Datei ist leer!");
                    throw new Error("Leere Datei: " + url);
                }
                addDebug("Datei geladen, versuche JSON zu parsen...");
                const data = JSON.parse(text);
                addDebug(`Erfolgreich geparst: ${data.length || Object.keys(data).length} Einträge`);
                return data;
            } catch (error) {
                addDebug("Fehler beim Laden/JSON-Parsen: " + error.message);
                throw error;
            }
        }

        function processData(clubsData, playersData, usersData, playerToUserMap) {
            addDebug("Starte Datenverarbeitung...");
            clubsMap = new Map();
            clubsData.forEach(club => {
                clubsMap.set(club.id, club.name);
            });
            addDebug(`Vereine verarbeitet: ${clubsMap.size}`);
            allPlayers = playersData.map(player => ({
                ...player,
                position: player.data?.position || "Unbekannt"
            }));
            addDebug(`Spieler verarbeitet: ${allPlayers.length}`);
            const userMap = new Map();
            usersData.forEach(user => {
                userMap.set(user.user.id, `${user.user.firstName} ${user.user.lastName || ''}`);
            });
            addDebug(`Benutzer verarbeitet: ${userMap.size}`);
            ownersMap = new Map();
            playerToUserMap.forEach(item => {
                const playerId = Object.keys(item)[0];
                const ownerId = item[playerId];
                ownersMap.set(playerId, userMap.get(ownerId) || `Unbekannt (${ownerId})`);
            });
            allPlayers.forEach(player => {
                if (!ownersMap.has(player.id)) {
                    ownersMap.set(player.id, "Computer");
                }
            });


            addDebug(`Besitzerzuordnungen: ${ownersMap.size}`);
            initClubFilter();
            initOwnerFilter();
            addDebug("Datenverarbeitung abgeschlossen.");
        }

        function initClubFilter() {
            const clubFilter = document.getElementById('club');
            clubFilter.innerHTML = '<option value="">Alle Vereine</option>';
            const uniqueClubs = [...new Set(clubsMap.values())].sort();
            uniqueClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club;
                option.textContent = club;
                clubFilter.appendChild(option);
            });
        }

        function initOwnerFilter() {
            const ownerFilter = document.getElementById('owner');
            ownerFilter.innerHTML = '<option value="">Alle Besitzer</option>';
            const ownerSet = new Set(ownersMap.values());
            ownerSet.forEach(owner => {
                if (owner !== "Kein Besitzer") {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    ownerFilter.appendChild(option);
                }
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showContent() {
            document.getElementById('content').style.display = 'block';
        }

        function showError(message) {
            hideLoading();
            const errorDiv = document.getElementById('error');
            document.getElementById('errorMessage').textContent = message;
            errorDiv.style.display = 'block';
        }

        function showStats() {
            const statsDiv = document.getElementById('stats');
            const statsText = document.getElementById('statsText');
            const updateTime = lastUpdateTime ? lastUpdateTime.toLocaleTimeString() : "Noch nicht aktualisiert";
            const anzahlBesitzer = (() => {
                const ownerSet = new Set(ownersMap.values());
                ownerSet.delete("Kein Besitzer");
                return ownerSet.size - 1;
            })();
            statsText.innerHTML = `📊 ${allPlayers.length} Spieler • ${clubsMap.size - 1} Vereine • ${anzahlBesitzer} Besitzer<br>
                                   🕒 Letztes Update: ${updateTime}`;
            statsDiv.style.display = 'block';
        }

        function getPlayerUrl(playerId) {
            const currentUrl = window.location.href;
            if (currentUrl.includes('htmlpreview.github.io')) {
                return `https://htmlpreview.github.io/?https://github.com/torresbig/comunioFanApp/blob/main/player.html?id=${playerId}`;
            } else if (currentUrl.includes('github.com') || currentUrl.includes('githubusercontent.com')) {
                return `https://htmlpreview.github.io/?https://github.com/torresbig/comunioFanApp/blob/main/player.html?id=${playerId}`;
            } else {
                return `player.html?id=${playerId}`;
            }
        }

        function renderTable(players) {
            const tableBody = document.querySelector('#playerTable tbody');
            tableBody.innerHTML = '';
            addDebug(`Rendere Tabelle mit ${players.length} Spielern`);
            players.forEach(player => {
                const row = document.createElement('tr');
                row.setAttribute('data-player-id', player.id);
                row.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'TH' && !e.target.closest('th')) {
                        addDebug(`Spieler angeklickt: ${player.name} (ID: ${player.id})`);
                        const playerUrl = getPlayerUrl(player.id);
                        addDebug(`Navigation zu: ${playerUrl}`);
                        window.location.href = playerUrl;
                    }
                });
                const clubId = player.data?.verein || "0";
                const clubName = clubsMap.get(clubId) || 'UNBEKANNT';
                const logoFile = getLogoFileName(clubId);
                const logoHtml = `<img src="logos/${logoFile}" class="club-logo" alt="${clubName}" title="${clubName}">`;
                const playerName = player.name || "Unbekannt";
                const playerId = player.id || "";
                const playerNameHtml = `<span title="${playerName} (ID: ${playerId})">${playerName}</span>`;
                const position = player.position || "Unbekannt";
                const hauptposition = player.data?.spielerDaten?.hauptposition || "N/A";
                const nebenpositionen = player.data?.spielerDaten?.nebenpositionen || [];
                const nebenpositionenTooltip = nebenpositionen.length > 0 ? "Hauptposition: " + hauptposition + " | Nebenposition: " + nebenpositionen.join(", ") : "";
                const positionHtml = `<span title="${nebenpositionenTooltip}">${player.position || "Unbekannt"}</span>`;
                const status = player.data?.status?.status || 'AKTIV';
                let statusClass = "";
                if (status.includes("AKTIV")) statusClass = "status-aktiv";
                else if (status.includes("VERLETZT")) statusClass = "status-verletzt";
                else if (status.includes("AUFBAU")) statusClass = "status-reha";
                else if (status.includes("ROTE_KARTE")) statusClass = "status-gesperrt";
                else if (status.includes("GELBROTE_KARTE")) statusClass = "status-gesperrt";
                else if (status.includes("FUENFTE_GELBE_KARTE")) statusClass = "status-gesperrt";
                else if (status.includes("NICHT_IN_LIGA")) statusClass = "status-nichtliga";
                else if (status.includes("NICHT_IM_KADER")) statusClass = "status-nichtliga";
                let marketValue = 'Unbekannt';
                let marketValueSort = 0;
                if (player.data?.wert) {
                    marketValueSort = player.data.wert;
                    marketValue = marketValueSort < 1000000
                        ? `${(marketValueSort / 1000).toFixed(0)} Tsd. €`
                        : `${(marketValueSort / 1000000).toFixed(2)} Mio. €`;
                }
                const owner = ownersMap.get(player.id) || 'Computer';
                const points = player.data?.punkte || 0;
                const lastUpdate = player.data?.lastUpdate || 'Unbekannt';
                row.innerHTML = `
                    <td data-sort="${playerName}">${playerNameHtml}</td>
                    <td data-sort="${clubName}">${logoHtml}</td>
                    <td data-sort="${position}">${positionHtml}</td>
                    <td data-sort="${status}" class="${statusClass}">${status}</td>
                    <td data-sort="${marketValueSort}">${marketValue}</td>
                    <td data-sort="${points}">${points}</td>
                    <td data-sort="${owner}">${owner}</td>
                    <td data-sort="${lastUpdate}">${lastUpdate}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function applyFilters() {
            addDebug("Filter werden angewendet...");
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const clubFilter = document.getElementById('club').value;
            const positionFilter = document.getElementById('position').value;
            const statusFilter = document.getElementById('status').value;
            const ownerFilter = document.getElementById('owner').value;
            const hideNonLeague = document.getElementById('hideNonLeague').checked;
            filteredPlayers = allPlayers.filter(player => {
                if (searchTerm &&
                    !player.name.toLowerCase().includes(searchTerm) &&
                    !player.id.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                if (clubFilter) {
                    const clubName = clubsMap.get(player.data?.verein) || '';
                    if (clubName !== clubFilter) return false;
                }
                if (positionFilter && player.position !== positionFilter) return false;
                const statusValue = player.data?.status?.status || '';
                if (statusFilter && !statusValue.includes(statusFilter)) return false;
                const owner = ownersMap.get(player.id) || 'Kein Besitzer';
                if (ownerFilter === "Kein Besitzer" && owner !== 'Kein Besitzer') return false;
                if (ownerFilter && ownerFilter !== "Kein Besitzer" && owner !== ownerFilter) return false;
                if (hideNonLeague && statusValue.includes("NICHT_IN_LIGA")) {
                    return false;
                }
                return true;
            });
            renderTable(filteredPlayers);
            addDebug("Filter angewendet.");
        }

        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('position').value = '';
            document.getElementById('status').value = '';
            document.getElementById('club').value = '';
            document.getElementById('owner').value = '';
            document.getElementById('hideNonLeague').checked = true;
            applyFilters();
            addDebug("Filter zurückgesetzt.");
        }

        function setupEventListeners() {
            document.getElementById('search').addEventListener('input', applyFilters);
            document.getElementById('position').addEventListener('change', applyFilters);
            document.getElementById('status').addEventListener('change', applyFilters);
            document.getElementById('club').addEventListener('change', applyFilters);
            document.getElementById('owner').addEventListener('change', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
        }

        function setupSorting() {
            const table = document.getElementById('playerTable');
            const headers = table.querySelectorAll('th[data-sort]');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortType = header.getAttribute('data-sort');
                    const columnIndex = [...header.parentNode.children].indexOf(header);
                    const rows = [...table.querySelectorAll('tbody tr')];
                    let sortOrder = 1;
                    if (header.classList.contains('sorted-asc')) {
                        header.classList.remove('sorted-asc');
                        header.classList.add('sorted-desc');
                        sortOrder = -1;
                    } else if (header.classList.contains('sorted-desc')) {
                        header.classList.remove('sorted-desc');
                        sortOrder = 0;
                    } else {
                        header.classList.add('sorted-asc');
                    }
                    headers.forEach(h => {
                        if (h !== header) {
                            h.classList.remove('sorted-asc', 'sorted-desc');
                        }
                    });
                    if (sortOrder === 0) {
                        applyFilters();
                        return;
                    }
                    rows.sort((a, b) => {
                        const aCell = a.children[columnIndex];
                        const bCell = b.children[columnIndex];
                        let aValue = aCell.getAttribute('data-sort') || aCell.textContent;
                        let bValue = bCell.getAttribute('data-sort') || bCell.textContent;
                        if (sortType === 'number' || sortType === 'value') {
                            aValue = parseFloat(aValue) || 0;
                            bValue = parseFloat(bValue) || 0;
                        }
                        return (aValue < bValue ? -1 : 1) * sortOrder;
                    });
                    const tbody = table.querySelector('tbody');
                    rows.forEach(row => tbody.appendChild(row));
                    addDebug(`Tabelle sortiert nach Spalte ${columnIndex + 1} (${sortOrder === 1 ? 'aufsteigend' : 'absteigend'})`);
                });
            });
        }
    </script>
    <script src="https://www.yogizaehler.de/Besucherzaehler/pz_018_2.php?id=7710741674&design=886000003"></script>

</body>

</html>
