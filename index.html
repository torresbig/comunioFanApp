<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>âš½ Comunio Ultraz - Spielerdatenbank</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #f5f5f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; background: linear-gradient(135deg, #1a2a6c, #2c3e50); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        h1 { font-size: 1.8rem; margin: 0; }
        .subtitle { margin: 8px 0 0; font-size: 1rem; opacity: 0.9; }

        .loading, .error, .stats { margin: 15px 0; padding: 18px; border-radius: 10px; }
        .loading { background: white; text-align: center; }
        .error { background: #fee; border: 1px solid #fcc; color: #c00; }
        .stats { background: #e8f5e8; border: 1px solid #c5e6c5; color: #2e7d2e; text-align: center; }

        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #2c3e50; color: white; position: sticky; top: 0; cursor: pointer; }
        th:hover { background: #34495e; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #f1f7ff; }

        .club-logo { width: 25px; height: 25px; object-fit: contain; margin-right: 10px; vertical-align: middle; }

        /* Debug */
        .debug-toggle { display: none; }
        .debug-label { background: #3498db; color: white; padding: 8px; border-radius: 6px; cursor: pointer; user-select: none; font-weight: bold; margin: 10px 0; display: block; }
        .debug-label::before { content: 'â–¶ '; transition: transform 0.3s; display: inline-block; width: 20px; }
        .debug-toggle:checked + .debug-label::before { transform: rotate(90deg); }
        .debug-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; background: #f0f8ff; border: 1px solid #cce; border-radius: 0 0 6px; margin-top: -5px; }
        .debug-toggle:checked + .debug-label + .debug-content { max-height: 200px; }
        .debug-inner { padding: 10px; font-family: monospace; font-size: 11px; }

        /* News */
        .panel { margin-bottom: 20px; border-radius: 8px; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .panel-header { background: #3498db; color: white; padding: 12px 16px; cursor: pointer; user-select: none; font-weight: bold; display: flex; align-items: center; font-size: 1.1em; }
        .panel-header::before { content: 'â–¶ '; transition: transform 0.3s; display: inline-block; width: 20px; }
        .panel-header.expanded::before { transform: rotate(90deg); }
        .panel-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; background: #f0f8ff; border-top: 1px solid #cce; }
        .panel-content.expanded { max-height: 500px; }
        .news-day { padding: 10px; border-bottom: 1px solid #e0e0e0; }
        .news-date { background: #1976d2; color: white; padding: 6px 10px; border-radius: 4px; display: inline-block; margin-bottom: 8px; }
        .news-category { font-weight: 600; margin-top: 8px; color: #1565c0; }
        .news-item { padding: 6px 10px; border-left: 3px solid #2196f3; margin: 4px 0; }

        /* Filter */
        .filters-collapsible { margin-bottom: 20px; border-radius: 8px; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .filters-header { background: #3498db; color: white; padding: 12px 16px; cursor: pointer; user-select: none; font-weight: bold; display: flex; align-items: center; font-size: 1.1em; }
        .filters-header::before { content: 'â–¶ '; transition: transform 0.3s; display: inline-block; width: 20px; }
        .filters-header.expanded::before { transform: rotate(90deg); }
        .filters-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .filters-content.expanded { max-height: 400px; }
        .filters { padding: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }

        .filter-group label { font-size: 13px; font-weight: bold; color: #2c3e50; margin-bottom: 4px; display: block; }
        .filter-group input, .filter-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .checkbox-group { display: flex; align-items: center; }
        .checkbox-group input { margin-right: 6px; }
        .reset-button { background: #5c6bc0; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 12px; }
        .reset-button:hover { background: #3f51b5; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>âš½ Comunio Ultraz - Spielerdatenbank</h1>
        <p class="subtitle">FuÃŸballspieler Daten â€¢ Live von GitHub</p>
    </header>

    <div id="debugSection">
        <input type="checkbox" id="debugToggle" class="debug-toggle">
        <label for="debugToggle" class="debug-label">Debug-Informationen</label>
        <div class="debug-content">
            <div class="debug-inner" id="debugContent"></div>
        </div>
    </div>

    <div id="newsSection" class="panel">
        <div class="panel-header" onclick="togglePanel('news')">News</div>
        <div id="newsPanel" class="panel-content"></div>
    </div>

    <div class="loading" id="loading"><p>ðŸ“¡ Lade aktuelle Spielerdaten...</p></div>
    <div class="error" id="error" style="display:none;"><p id="errorMessage"></p></div>
    <div class="stats" id="stats" style="display:none;"><span id="statsText"></span> <button id="refreshButton">ðŸ”„</button></div>

    <div id="filterSection" class="filters-collapsible">
        <div class="filters-header" onclick="togglePanel('filters')">Filter</div>
        <div id="filtersPanel" class="filters-content">
            <div class="filters">
                <div class="filter-group">
                    <label for="search">Spieler suchen</label>
                    <input type="text" id="search">
                </div>
                <div class="filter-group">
                    <label for="position">Position</label>
                    <select id="position"><option value="">Alle</option><option>TORHÃœTER</option><option>ABWEHR</option><option>MITTELFELD</option><option>STURM</option></select>
                </div>
                <div class="filter-group">
                    <label for="status">Status</label>
                    <select id="status"><option value="">Alle</option><option>AKTIV</option><option>VERLETZT</option><option>AUFBAUTRAINING</option><option>NICHT_IN_LIGA</option></select>
                </div>
                <div class="filter-group">
                    <label for="club">Verein</label>
                    <select id="club"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
                    <label for="owner">Besitzer</label>
                    <select id="owner"><option value="">Alle</option><option>Kein Besitzer</option></select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="hideNonLeague" checked><label for="hideNonLeague">Nicht-in-Liga ausblenden</label>
                </div>
                <button class="reset-button" id="resetFilters">Reset</button>
            </div>
        </div>
    </div>

    <div id="content" style="display:none;">
        <div class="table-container">
            <table id="playerTable">
                <thead><tr>
                    <th data-sort="string">Spieler</th>
                    <th data-sort="string">Verein</th>
                    <th data-sort="string">Position</th>
                    <th data-sort="string">Status</th>
                    <th data-sort="value">Marktwert</th>
                    <th data-sort="number">Punkte</th>
                    <th data-sort="string">Besitzer</th>
                    <th data-sort="string">Update</th>
                </tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
function togglePanel(name) {
    const hdr = document.getElementById(name+'Section')?.querySelector('.panel-header') || document.getElementById(name+'Section')?.querySelector('.filters-header');
    const pnl = document.getElementById(name+'Panel');
    hdr.classList.toggle('expanded');
    pnl.classList.toggle('expanded');
}
function parseGermanDate(s){const [d,m,y]=s.split('.');return new Date(y,m-1,d);}

fetch('News.json').then(r=>r.json()).then(data=>{
  const panel=document.getElementById('newsPanel'), arr=data.sort((a,b)=>parseGermanDate(b.date)-parseGermanDate(a.date));
  panel.innerHTML=arr.length?arr.map(day=>{
    const grp=Object.entries(day.news.reduce((o,n)=>(o[n.art]=o[n.art]||[],o[n.art].push(n),o),{}));
    return `<div class="news-day"><div class="news-date">${day.date}</div>${grp.map(([art,list])=>`<div class="news-category">${art}</div>${list.map(n=>`<div class="news-item">${(()=>{try{const o=JSON.parse(n.text);return art==='TRANSFER'?`${o.playerName} von ${o.seller} zu ${o.buyer} fÃ¼r ${o.price.toLocaleString('de-DE')} â‚¬`:`${n.text}`;}catch{return n.text;}})()}</div>`).join('')}`).join('')}</div>`;
  }).join(''):'<div class="news-item">Keine News.</div>';
}).catch(_=>document.getElementById('newsPanel').innerHTML='<div class="news-item">Fehler.</div>');

const G=`https://raw.githubusercontent.com/torresbig/comunioFanApp/main/`, U={clubs:`${G}VereinsdatenbankJson.txt`,players:`${G}SpielerdatenbankNeutralJson.txt`,users:`${G}UserdatenbankJson_884691.txt`,map:`${G}PlayerToUserMap_884691.txt`};
let allPlayers=[], clubsMap=new Map(), ownersMap=new Map(), filtered=[];
function dbg(m){const d=document.getElementById('debugContent');d.innerHTML+=`<div>${new Date().toLocaleTimeString()}: ${m}</div>`;d.scrollTop=d.scrollHeight;}
async function fJSON(u){dbg('Lade '+u);let r=await fetch(u+'?t='+Date.now());if(!r.ok)throw new Error(r.status);let t=await r.text();if(!t.trim())throw new Error('leer');return JSON.parse(t);}
async function loadData(){
  try{
    document.getElementById('loading').style.display='block';
    const [cd,pd,ud,md]=await Promise.all([fJSON(U.clubs),fJSON(U.players),fJSON(U.users),fJSON(U.map)]);
    clubsMap=new Map(cd.map(c=>[c.id,c.name]));
    allPlayers=pd.map(p=>({...p,position:p.data?.position||'Unbekannt'}));
    const um=new Map(ud.map(u=>[u.user.id,`${u.user.firstName} ${u.user.lastName||''}`]));
    ownersMap=new Map();
    md.forEach(i=>{const id=Object.keys(i)[0];ownersMap.set(id,um.get(i[id])||'Unbekannt');});
    allPlayers.forEach(p=>{if(!ownersMap.has(p.id))ownersMap.set(p.id,'Computer');});
    showStats();document.getElementById('loading').style.display='none';document.getElementById('content').style.display='block';
    applyFilters();setupSorting();setupFilters();
  }catch(e){dbg(e.message);document.getElementById('errorMessage').textContent=e.message;document.getElementById('error').style.display='block';}
}
function showStats(){
  const o=new Set(ownersMap.values());o.delete('Kein Besitzer');
  document.getElementById('statsText').innerHTML=`ðŸ“Š ${allPlayers.length} Spieler â€¢ ${clubsMap.size} Vereine â€¢ ${o.size} Besitzer<br>ðŸ•’ ${new Date().toLocaleTimeString()}`;
  document.getElementById('stats').style.display='block';
}
function renderTable(arr){
  const tb=document.querySelector('#playerTable tbody');tb.innerHTML='';
  arr.forEach(p=>{
    const mv=p.data?.wert||0, mvT=mv<1e6?`${(mv/1e3).toFixed(0)} Tsd.`:`${(mv/1e6).toFixed(2)} Mio.`;
    tb.innerHTML+=`<tr onclick="location='player.html?id=${p.id}'">
      <td>${p.name}</td>
      <td><img src="logos/${(clubsMap.get(p.data?.verein)||'unbestimmt')}.png" class="club-logo"></td>
      <td>${p.position}</td>
      <td>${p.data?.status?.status||'AKTIV'}</td>
      <td>${mvT} â‚¬</td>
      <td>${p.data?.punkte||0}</td>
      <td>${ownersMap.get(p.id)}</td>
      <td>${p.data?.lastUpdate||''}</td>
    </tr>`;
  });
}
function applyFilters(){
  const s=document.getElementById('search').value.toLowerCase(), pos=document.getElementById('position').value,
        st=document.getElementById('status').value, cb=document.getElementById('club').value,
        hide=document.getElementById('hideNonLeague').checked;
  filtered=allPlayers.filter(p=>{
    if(s&&!p.name.toLowerCase().includes(s))return false;
    if(pos&&p.position!==pos)return false;
    const ps=p.data?.status?.status||'';
    if(st&&!ps.includes(st))return false;
    if(cb&&clubsMap.get(p.data?.verein)!==cb)return false;
    if(hide&&ps.includes('NICHT_IN_LIGA'))return false;
    return true;
  });
  renderTable(filtered);
}
function setupSorting(){
  document.querySelectorAll('th[data-sort]').forEach(th=>{
    th.onclick=()=>{
      const idx=[...th.parentNode.children].indexOf(th), type=th.dataset.sort;
      const rows=[...document.querySelectorAll('#playerTable tbody tr')];
      const asc=!th.classList.toggle('sorted-asc');
      rows.sort((a,b)=>{
        let A=a.cells[idx].textContent.trim(), B=b.cells[idx].textContent.trim();
        if(type==='number'||type==='value'){A=parseFloat(A)||0;B=parseFloat(B)||0;}
        return (A>B?1:-1)*(asc?1:-1);
      });
      rows.forEach(r=>r.parentNode.appendChild(r));
    };
  });
}
function setupFilters(){
  ['search','position','status','club'].forEach(id=>document.getElementById(id).oninput=applyFilters);
  document.getElementById('hideNonLeague').onchange=applyFilters;
  document.getElementById('resetFilters').onclick=()=>{['search','position','status','club'].forEach(id=>document.getElementById(id).value='');document.getElementById('hideNonLeague').checked=true;applyFilters();};
}
document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
