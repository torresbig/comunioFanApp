<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontost√§nde der Nutzer</title>
  <link rel="stylesheet" href="css/playerTable.css">
  <link rel="stylesheet" href="css/tabelStyle.css">
  <link rel="stylesheet" href="css/styleMenueHamburger.css">
  <link rel="stylesheet" href="css/debugPanel.css">
  <link rel="stylesheet" href="css/buttonBack.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    h1 {
      margin-bottom: 20px;
      text-align: center;
    }





    #loading {
      margin: 15px;
      text-align: center;
      font-style: italic;
    }

    .asc::after {
      content: " ‚ñ≤";
    }

    .desc::after {
      content: " ‚ñº";
    }



    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>



  <h1>Kontost√§nde der Nutzer</h1>
  <div id="loading">Daten werden geladen, bitte warten...</div>

  <div class="table-container">
    <table id="kontostandTable" style="display:none;">
      <thead>
        <tr>
          <th data-sort="number">#</th>
          <th data-sort="string">Nutzer</th>
          <th data-sort="number">Kontostand (‚Ç¨)</th>
          <th data-sort="number">Mannschaftswert (‚Ç¨)</th>
          <th data-sort="number">Gesamtwert (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>


  <!-- Debug Button -->
  <button id="floatingDebugBtn" title="Debug">üêû</button>
  <div id="floatingDebugPanel">
    <div id="floatingDebugPanelHeader">
      Debug-Informationen
      <button id="floatingDebugPanelClose" title="Schlie√üen">√ó</button>
    </div>
    <div id="floatingDebugContent"></div>
  </div>


  <div class="hamburger-menu">
    <button class="hamburger-button" id="hamburgerButton">
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
    </button>
    <div class="hamburger-dropdown" id="hamburgerDropdown">
      <a href="#" class="menu-item" id="linkIndex">Startseite</a>
      <a href="#" class="menu-item" id="linkTransferuebersicht">üîÑ Transfer√ºbersicht</a>
      <a href="#" class="menu-item" id="linkUseruebersicht">üë§ User√ºbersicht</a>
      <a href="https://www.instagram.com/comuniofanapp/." class="menu-item" target="_blank">üì∏ Instagram:
        ComunioFanApp</a>
    </div>
  </div>




  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/debugPanel.js"></script>
  <script src="js/hamburgerMenu.js"></script>


  <script>

    addDebug("Seite geladen.");



    // Lade und erzeuge Tabelle
    async function loadData() {
      addDebug("Lade Daten...");
      document.getElementById('loading').style.display = 'block';

      try {
        const [usersRes, playersRes, mapRes] = await Promise.all([
          fetch(DATA_URLS.users), fetch(DATA_URLS.players), fetch(DATA_URLS.playerToUser)
        ]);
        if (!usersRes.ok || !playersRes.ok || !mapRes.ok) {
          addDebug("Fehler beim Laden der Daten.");
          alert('Fehler beim Laden der Spieldaten.');
          return;
        }
        const usersData = await usersRes.json();
        const playersData = await playersRes.json();
        const playerToUserMap = await mapRes.json();

        addDebug(`Daten geladen: Nutzer (${usersData.length}), Spieler (${playersData.length})`);
        buildTable(usersData, playersData, playerToUserMap);
      } catch (err) {
        addDebug(`Fehler: ${err.message}`);
        alert('Fehler: ' + err.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('kontostandTable').style.display = 'table';

      }
    }

    // Tabelle bauen
    function buildTable(users, playersData, playerToUserMap) {
      addDebug("Baue Tabelle...");

      const spielerArray = playersData.playerDB || [];

      // Unbedingt zuerst Map erstellen
      const playerToUserMapObj = {};
      for (const entry of playerToUserMap) {
        const playerId = Object.keys(entry)[0];
        const userId = entry[playerId];
        playerToUserMapObj[playerId] = userId;
      }

      const userTeamValues = {};
      for (const user of users) {
        userTeamValues[user.user.id] = 0;
      }

      // Mannschaftswerte summieren
      for (const player of spielerArray) {
        const playerIdStr = player.id.toString(); // Sicher String
        const userId = playerToUserMapObj[playerIdStr];

        addDebug(`Player-ID ${playerIdStr} mapped to User-ID ${userId || "undefined"}`);

        if (userId && userTeamValues[userId] !== undefined) {
          const wert = player.data?.wert || 0;
          userTeamValues[userId] += wert;
        }
      }

      let data = users.filter(u => u.user.id !== '1').map(u => {
        const kontostand = u.guthaben || 0;
        const mannschaftswert = userTeamValues[u.user.id] || 0;
        if (u.teamValue || u.teamValue !== undefined || u.teamValue !== null) {
          const mannschaftswertComunio = u.teamValue;

          function parseDateDMY(dateStr) {
            // Datum im Format "TT.MM.JJJJ"
            const [day, month, year] = dateStr.split('.').map(Number);
            return new Date(year, month - 1, day); // Monat ist 0-basiert
          }

          if (mannschaftswert !== mannschaftswertComunio) {
            if (u.lastUpdate) {
              const lastUpdate = parseDateDMY(u.lastUpdate);

              if (!isNaN(lastUpdate)) {
                const heute = new Date();
                heute.setHours(0, 0, 0, 0);         // Mitternacht heute
                lastUpdate.setHours(0, 0, 0, 0);   // Mitternacht lastUpdate

                if (lastUpdate < heute) {
                  addDebug(`Warnung: Mannschaftswert f√ºr ${u.user.loginName} ist veraltet! Letzte Aktualisierung: ${lastUpdate.toLocaleDateString()}`);
                  mannschaftswert = mannschaftswertComunio;
                } else {
                  addDebug(`Mannschaftswert f√ºr ${u.user.loginName} ist aktuell: ${mannschaftswert}! Evtl sind updates, die √ºber den Tag kamen nicht mit drin! `);
                }
              } else {
                addDebug(`Ung√ºltiges Datum bei lastUpdate f√ºr ${u.user.loginName}: ${u.lastUpdate}`);
              }
            }
          } else {
            addDebug(`Mannschaftswert f√ºr ${u.user.loginName} stimmt √ºberein: ${mannschaftswert}`);
          }

        }


        addDebug(`User ${u.user.loginName}: Kontostand=${kontostand}, Mannschaftswert=${mannschaftswert}`);

        return {
          nutzer: u.user.firstName + (u.user.lastName ? ' ' + u.user.lastName : ''),
          kontostand: kontostand,
          mannschaftswert: mannschaftswert,
          gesamtwert: kontostand + mannschaftswert
        };
      });

      // Nach Gesamtwert absteigend sortieren
      data.sort((a, b) => b.gesamtwert - a.gesamtwert);

      data.forEach((d, i) => d.rank = i + 1);

      const tbody = document.querySelector('#kontostandTable tbody');
      tbody.innerHTML = '';

      for (const row of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${row.rank}</td>
      <td style="text-align:left;">${row.nutzer}</td>
      <td>${row.kontostand.toLocaleString('de-DE')}</td>
      <td>${row.mannschaftswert.toLocaleString('de-DE')}</td>
      <td>${row.gesamtwert.toLocaleString('de-DE')}</td>
    `;
        tbody.appendChild(tr);
      }

      setupSorting(data);
      addDebug("Tabelle gebaut und angezeigt.");
    }



    // Sortierung erm√∂glichen
    function setupSorting(data) {
      const headers = document.querySelectorAll('#kontostandTable th');
      let currentSort = { index: 4, dir: 'desc' };

      headers.forEach((header, i) => {
        header.addEventListener('click', () => {
          const type = header.getAttribute('data-sort');
          let dir = 'asc';
          if (currentSort.index === i) {
            dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
          }
          currentSort = { index: i, dir: dir };

          data.sort((a, b) => {
            let va, vb;
            switch (i) {
              case 0: va = a.rank; vb = b.rank; break;
              case 1: va = a.nutzer.toLowerCase(); vb = b.nutzer.toLowerCase(); break;
              case 2: va = a.kontostand; vb = b.kontostand; break;
              case 3: va = a.mannschaftswert; vb = b.mannschaftswert; break;
              case 4: va = a.gesamtwert; vb = b.gesamtwert; break;
            }
            if (type === 'number') return dir === 'asc' ? va - vb : vb - va;
            if (va < vb) return dir === 'asc' ? -1 : 1;
            if (va > vb) return dir === 'asc' ? 1 : -1;
            return 0;
          });

          if (i !== 0) data.forEach((d, idx) => d.rank = idx + 1);

          const tbody = document.querySelector('#kontostandTable tbody');
          tbody.innerHTML = '';
          for (const row of data) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${row.rank}</td>
          <td style="text-align:left;">${row.nutzer}</td>
          <td>${row.kontostand.toLocaleString('de-DE')}</td>
          <td>${row.mannschaftswert.toLocaleString('de-DE')}</td>
          <td>${row.gesamtwert.toLocaleString('de-DE')}</td>
        `;
            tbody.appendChild(tr);
          }
          updateSortIndicators(i, dir);
        });
      });

      updateSortIndicators(currentSort.index, currentSort.dir);
    }

    function updateSortIndicators(activeIndex, dir) {
      document.querySelectorAll('#kontostandTable th').forEach((th, i) => {
        th.classList.toggle('asc', i === activeIndex && dir === 'asc');
        th.classList.toggle('desc', i === activeIndex && dir === 'desc');
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>

</body>

</html>