<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User & Transfers</title>
  <link rel="stylesheet" href="css/useruebersicht.css">
  <link rel="stylesheet" href="css/stylePlayer.css">
  <link rel="stylesheet" href="css/tabelStyle.css">
  <link rel="stylesheet" href="css/styleMenueHamburger.css">
  <link rel="stylesheet" href="css/debugPanel.css">
  <link rel="stylesheet" href="css/buttonBack.css">
  <link rel="stylesheet" href="css/userInfo.css">
</head>

<body>
  <!-- Floating Debug Button and Panel -->
  <button id="floatingDebugBtn" title="Debug"><span style="pointer-events:none;">üêû</span></button>
  <div id="floatingDebugPanel">
    <div id="floatingDebugPanelHeader">
      Debug-Informationen
      <button id="floatingDebugPanelClose" title="Schlie√üen">√ó</button>
    </div>
    <div id="floatingDebugContent"></div>
  </div>

  <!-- Hamburger-Men√º -->
  <div class="hamburger-menu">
    <button class="hamburger-button" id="hamburgerButton">
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
    </button>
    <div class="hamburger-dropdown" id="hamburgerDropdown">
      <a href="#" class="menu-item" id="linkIndex">üìã Spielerdatenbank</a>
      <a href="#" class="menu-item" id="linkNews">üì∞ News</a>
      <a href="#" class="menu-item" id="linkTransfermarktComunio">üìë Transfermarkt-Liste</a>
      <a href="#" class="menu-item" id="linkTransferuebersicht">üîÑ Transfer√ºbersicht</a>
      <a href="https://www.instagram.com/comuniofanapp/." class="menu-item" target="_blank">üì∏ Instagram:
        ComunioFanApp</a>
      <div class="menu-item menu-tarn" id="menuTarnItem" style="font-size:0.95em; color:#888; cursor:pointer;">
        erstellt von comunioFanApp</div>
    </div>
  </div>
  <header>
    <nav class="navbar">
      <div class="navbar-header">
        <div class="player-center">
          <h1>User & Transfers</h1>
        </div>
      </div>
    </nav>
  </header>
  <main class="user-overview">

    <!-- User Dropdown -->
    <div class="dropdown">
      <button id="userSelectBtn">User w√§hlen ‚ñº</button>
      <ul id="userDropdown"></ul>
      <div id="urlNotice" style="display:none; color:#b33; margin-top:6px; font-size:0.95em;"></div>
    </div>

    <!-- User Info Card (under dropdown) -->
    <div id="userInfo" class="user-info-card" style="display:none;">
      <!-- dynamically filled -->
    </div>

    <!-- Spieler-Tabelle + Details nebeneinander -->
    <div class="player-section">
      <div class="rivals-table-container">
        <table id="playerTable" class="rivals-table">
          <thead>
            <tr>
              <th>Spieler</th>
              <th>Verein</th>
              <th>Position</th>
              <th>Status</th>
              <th>Marktwert</th>
              <th>Punkte</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="details-card" id="playerDetails">
        <h2>Spieler-Details</h2>
        <p id="detailText">Bitte Spieler ausw√§hlen</p>
        <!-- Du kannst hier weitere Details dynamisch hinzuf√ºgen -->
      </div>
    </div>

    <!-- Transfers mit Tabs -->
    <div class="transfer-section">
      <div class="tabs">
        <button class="tab-button active" data-tab="tab-all">Alle</button>
        <button class="tab-button" data-tab="tab-buy">K√§ufe</button>
        <button class="tab-button" data-tab="tab-sell">Verk√§ufe</button>
      </div>
      <div id="tab-all" class="tab-content active">
        <table id="transferTableAll" class="rivals-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Spieler</th>
              <th>Art</th>
              <th>Preis</th>
              <th>Gegen√ºber</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="tab-buy" class="tab-content">
        <table id="transferTableBuy" class="rivals-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Spieler</th>
              <th>Preis</th>
              <th>Verk√§ufer</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="tab-sell" class="tab-content">
        <table id="transferTableSell" class="rivals-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Spieler</th>
              <th>Preis</th>
              <th>K√§ufer</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </main>

  <script src="js/config.js"></script>
  <script src="js/debugPanel.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/hamburgerMenu.js"></script>
  <script src="js/playerDisplayTabs.js"></script>
  <script src="js/generatePlayerTable.js"></script>
  <script src="js/smokeTest.js" type="module"></script>
  <script src="js/userInfo.js"></script>

  <script>
    let newsData, playersData, p2uData, usersData, clubsData;
    const clubsMap = new Map();
    const ownersMap = new Map();
    // URL-Parameter (werden nach dem Laden der Daten gesetzt)
    let urlParams = { username: null, withMenue: true };

    // Liest URL-Parameter: ?username=Name&withMenue=false
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        username: params.get('username'),
        withMenue: params.get('withMenue') !== 'false'
      };
    }


    // Findet User anhand Vor- oder Nachname (case-insensitive)
    function findUserByName(users, username) {
      if (!username) return null;
      const name = username.toLowerCase();
      return users.find(u => (
        (u.user.firstName && u.user.firstName.toLowerCase() === name) ||
        (u.user.lastName && u.user.lastName.toLowerCase() === name)
      )) || null;
    }

    // Verarbeitet Params (z.B. Men√º ausblenden)
    function processUrlParams(params) {
      // Men√º anzeigen/ausblenden
      const hamburgerMenu = document.querySelector('.hamburger-menu');
      if (hamburgerMenu) hamburgerMenu.style.display = params.withMenue ? '' : 'none';
      // Merken f√ºr sp√§teren Gebrauch (initUserDropdown)
      urlParams = params;
    }

    // Lade alle ben√∂tigten Daten
    async function loadData() {
      try {
        [clubsData, playersData, usersData, p2uData, newsData] = await Promise.all([
          fetchJSON(DATA_URLS.clubs),
          fetchJSON(DATA_URLS.players),
          fetchJSON(DATA_URLS.users),
          fetchJSON(DATA_URLS.playerToUser),
          fetchJSON(DATA_URLS.news)
        ]);

        // ClubsMap aufbauen
        clubsData.forEach(club => {
          if (club?.id && club?.name) {
            clubsMap.set(club.id, club.name);
          }
        });

        // OwnersMap - Beispiel: alle User als Besitzer "Computer" default-Map
        usersData.forEach(user => {
          ownersMap.set(user.user.id, user.user.firstName || 'Computer');
        });

        // URL-Parameter parsen und verarbeiten (funktioniert auch wenn keine params vorhanden sind)
        const params = getUrlParams();
        processUrlParams(params);

        initUserDropdown();
        initTabs();
        // Run smoke tests (module import via dynamic import to avoid module scoping issues)
        try {
          import('./js/smokeTest.js').then(m => {
            if (m && typeof m.runSmokeTest === 'function') {
              m.runSmokeTest({ newsData, playersData, usersData, p2uData });
            }
          }).catch(err => addDebug && addDebug('SmokeTest import error: ' + err.message));
        } catch (err) {
          addDebug && addDebug('SmokeTest error: ' + err.message);
        }
      } catch (error) {
        console.error("Fehler beim Laden:", error); // <-- alles ausgeben, nicht nur message!
        addDebug("Fehler beim Laden: " + (error && error.message ? error.message : JSON.stringify(error)));
      }
    }

    async function fetchJSON(url) {
      addDebug(`Lade Datei: ${url}`);
      const cacheBusterUrl = url + '?t=' + new Date().getTime();
      try {
        const response = await fetch(cacheBusterUrl);
        if (!response.ok) {
          addDebug(`Fehler beim Laden: HTTP ${response.status}`);
          throw new Error(`HTTP ${response.status} f√ºr ${url}`);
        }
        const text = await response.text();
        if (!text.trim()) {
          addDebug("Warnung: Datei ist leer!");
          throw new Error("Leere Datei: " + url);
        }
        addDebug("Datei geladen, versuche JSON zu parsen...");
        const data = JSON.parse(text);
        addDebug(`Erfolgreich geparst: ${data.length || Object.keys(data).length} Eintr√§ge`);
        return data;
      } catch (error) {
        addDebug("Fehler beim Laden/JSON-Parsen: " + error.message);
        throw error;
      }
    }

    function initUserDropdown() {
      const btn = document.getElementById('userSelectBtn');
      const ul = document.getElementById('userDropdown');

      // Nur echte User nehmen!
      const realUsers = usersData.filter(u => u.user.firstName !== "Computer");

      ul.innerHTML = '';

      realUsers.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u.user.firstName + (u.user.lastName ? ' ' + u.user.lastName : '');
        li.onclick = () => {
          btn.textContent = li.textContent + ' ‚ñº';
          ul.classList.remove('show');
          loadPlayersForUser(u.user.id);
        };
        ul.appendChild(li);
      });

      btn.onclick = function (e) {
        ul.classList.toggle('show');
        e.stopPropagation(); // Verhindert sofortiges Schlie√üen!
      };

      // Schlie√üt das Dropdown beim Klick √ºberall sonst
      document.addEventListener('click', function (e) {
        if (!e.target.closest('.dropdown')) ul.classList.remove('show');
      });

      // Wenn ein username-Parameter gesetzt ist, versuche den User zu finden
      if (urlParams && urlParams.username) {
        const userFromUrl = findUserByName(usersData, urlParams.username);
        const noticeEl = document.getElementById('urlNotice');
        if (userFromUrl) {
          const displayName = userFromUrl.user.firstName + (userFromUrl.user.lastName ? ' ' + userFromUrl.user.lastName : '');
          // Ersetze den Button durch ein unver√§nderliches Label (sauberer als disabled button)
          btn.style.display = 'none';
          ul.style.display = 'none';
          const label = document.createElement('div');
          label.id = 'selectedUserLabel';
          label.textContent = displayName;
          label.style.fontWeight = '600';
          label.style.margin = '6px 0';
          // F√ºge das Label an Stelle des Buttons ein
          btn.parentNode.insertBefore(label, btn);
          addDebug(`Username aus URL verwendet: ${displayName}`);
          loadPlayersForUser(userFromUrl.user.id);
          return; // fertig
        } else {
          const msg = `Username in URL nicht gefunden: ${urlParams.username} ‚Äî zeige Standard-User.`;
          addDebug(msg);
          if (noticeEl) {
            noticeEl.textContent = msg;
            noticeEl.style.display = 'block';
          }
        }
      }

      // Beim Start: Ersten echten User vorausw√§hlen (Fallback)
      const firstUser = realUsers[0];
      if (firstUser) {
        btn.textContent = firstUser.user.firstName + (firstUser.user.lastName ? ' ' + firstUser.user.lastName : '') + ' ‚ñº';
        loadPlayersForUser(firstUser.user.id);
      }
    }

    const ul = document.getElementById('userDropdown');

    document.addEventListener('click', function (e) {
      // Schlie√üe Dropdown nur, wenn es existiert und offen ist
      if (ul && ul.classList.contains('show') && !e.target.closest('.dropdown')) {
        ul.classList.remove('show');
      }
    });

    function getPlayerUrlWithParams(playerId) {
       let playerUrl = getPlayerUrl(playerId);
        if (urlParams.withMenue === false) {
          playerUrl += '&withMenue=false';
        }
        return playerUrl;
    }

   

    // Spieler f√ºr ausgew√§hlten User laden und Tabelle rendern
    function loadPlayersForUser(userId) {
      addDebug("=== loadPlayersForUser START ===");
      // Render user info card for selected user (if available)
      try { renderUserInfo(userId); } catch (err) { addDebug && addDebug('renderUserInfo error: ' + err.message); }
      const map = Object.assign({}, ...p2uData);
      let list = (playersData.playerDB || []).filter(p => map[p.id] == userId);

      addDebug(`Found ${list.length} players for user ${userId}`);

      // Debug positions before sorting
      list.forEach(p => {
        addDebug(`Player ${p.name}: Position = ${p.data?.position}`);
      });

      // Hilfsfunktion f√ºr Positionssortierung
      const getPositionSortValue = (position) => {
        const positionOrder = {
          'TORH√úTER': 0,
          'ABWEHR': 1,
          'MITTELFELD': 2,
          'STURM': 3
        };
        const value = positionOrder[position];
        if (value === undefined) {
          addDebug(`WARNING: Unknown position: ${position}`);
          return 999; // Unbekannte Positionen ans Ende
        }
        return value;
      };

      // Liste nach Position sortieren
      const sortedList = [...list].sort((a, b) => {
        const posA = getPositionSortValue(a.data?.position || '');
        const posB = getPositionSortValue(b.data?.position || '');

        if (posA !== posB) {
          return posA - posB;
        }

        // Bei gleicher Position nach Name sortieren
        return a.name.localeCompare(b.name, 'de', { sensitivity: 'base' });
      });

      // Debug positions after sorting
      addDebug("=== Sorted Players ===");
      sortedList.forEach(p => {
        addDebug(`${p.data?.position}: ${p.name}`);
      });

      // Rendere die sortierte Liste und erzwinge die Positionssortierung
      renderTable(sortedList);
      // Warte einen kurzen Moment und sortiere dann nochmal explizit nach Position
      setTimeout(() => {
        const playerTable = document.getElementById('playerTable');
        if (playerTable) {
          sortTable(playerTable, 2); // Position ist Spalte 2 (0-basiert)
        }
      }, 100);
      clearDetails();

      renderTransfers(userId);
      addDebug("=== loadPlayersForUser END ===");
    }

    // Spielerdetails f√ºllen
    function fillPlayerDetails(player) {
      const details = document.getElementById('detailText');
      details.innerHTML = `
      <strong>${player.name}</strong><br>
      ID: ${player.id}<br>
      Verein: ${player.data?.verein || "-"}<br>
      Marktwert: ‚Ç¨${player.data?.wert?.toLocaleString('de-DE') || "-"}<br>
      Punkte: ${player.data?.punkte || "0"}<br>
      Status: ${player.data?.comunioStatus?.status || "-"}
    `;
    }

    function clearDetails() {
      const details = document.getElementById('detailText');
      details.innerHTML = 'Bitte Spieler ausw√§hlen';
    }

    // Spieler-Tabelle rendern (aus generatePlayerTable.js)
    function renderTable(players) {
      const tableBody = document.querySelector('#playerTable tbody');
      tableBody.innerHTML = '';
      addDebug(`Rendere Tabelle mit ${players.length} Spielern`);
      players.forEach(player => {
        const row = document.createElement('tr');
        row.setAttribute('data-player-id', player.id);
        row.addEventListener('click', () => {
          document.querySelectorAll('#playerTable tr').forEach(r => r.classList.remove('selected'));
          row.classList.add('selected');
          fillPlayerDetails(player);
        });

        

        const clubId = player.data?.verein || "0";
        const clubName = clubsMap.get(clubId) || 'UNBEKANNT';
        const logoFile = getLogoFileName(clubId);
        const logoHtml = `<img src="logos/${logoFile}" class="club-logo" alt="${clubName}" title="${clubName}">`;
        const playerNameHtml = `<a href="${getPlayerUrlWithParams(player.id)}" title="${player.name} (ID: ${player.id})" target="_self">${player.name}</a>`;

        // Position mit Sortier-Index
        const positionOrder = {
          'TORH√úTER': 0,
          'ABWEHR': 1,
          'MITTELFELD': 2,
          'STURM': 3
        };
        const position = player.data?.position || "Unbekannt";
        const positionSortValue = positionOrder[position] ?? 999;
        const hauptposition = player.data?.spielerDaten?.hauptposition || "N/A";
        const nebenpositionen = player.data?.spielerDaten?.nebenpositionen || [];
        const nebenpositionenTooltip = nebenpositionen.length > 0 ? "Hauptposition: " + hauptposition + " | Nebenposition: " + nebenpositionen.join(", ") : "";
        const positionHtml = `<span title="${nebenpositionenTooltip}">${position}</span>`;
        const status = player.data?.status?.status || 'AKTIV';

        let statusClass = "";
        if (status.includes("AKTIV")) statusClass = "status-aktiv";
        else if (status.includes("VERLETZT")) statusClass = "status-verletzt";
        else if (status.includes("AUFBAU")) statusClass = "status-reha";
        else if (status.includes("ROTE_KARTE") || status.includes("GELBROTE_KARTE") || status.includes("FUENFTE_GELBE_KARTE")) statusClass = "status-gesperrt";
        else if (status.includes("NICHT_IN_LIGA") || status.includes("NICHT_IM_KADER")) statusClass = "status-nichtliga";

        let marketValue = 'Unbekannt';
        let marketValueSort = 0;
        if (player.data?.wert) {
          marketValueSort = player.data.wert;
          marketValue = marketValueSort < 1000000
            ? `${(marketValueSort / 1000).toFixed(0)} Tsd. ‚Ç¨`
            : `${(marketValueSort / 1000000).toFixed(2)} Mio. ‚Ç¨`;
        }
        const points = player.data?.punkte || 0;
        const lastUpdate = player.data?.lastUpdate || 'Unbekannt';

        row.innerHTML = `
        <td data-sort="${player.name}">${playerNameHtml}</td>
        <td data-sort="${clubName}">${logoHtml}</td>
        <td data-sort="${String(positionSortValue).padStart(3, '0')}_${position}">${positionHtml}</td>
        <td data-sort="${status}" class="${statusClass}">
  <span title="${getStatusDisplayName(status)}">${getStatusIndicator(status)}</span>
</td>
        <td data-sort="${marketValueSort}">${marketValue}</td>
        <td data-sort="${points}">${points}</td>
      `;
        tableBody.appendChild(row);
      });

      // Initial sort by position (column index 2)
      sortTable(document.getElementById('playerTable'), 2);
    }

    // Transfers anzeigen (mit Filtern f√ºr K√§ufe/Verk√§ufe)
    function renderTransfers(userId) {
      addDebug("=== renderTransfers START ===");

      const entries = [];
      try {
        newsData.newsDB.forEach(day => {
          day.news.forEach(item => {
            if (item.art === 'TRANSFER') {
              const t = JSON.parse(item.text);
              const isMyPurchase = t.buyerId && t.buyerId == userId;
              const isMySale = t.sellerId && t.sellerId == userId;

              if (isMyPurchase || isMySale) {
                const playerObj = playersData.playerDB.find(p => p.id === item.playerId);
                addDebug(`Transfer found: ${playerObj?.name || t.playerName || 'Unknown'} (ID: ${item.playerId})`);
                entries.push({
                  playerId: item.playerId,
                  playerName: playerObj?.name || t.playerName,
                  date: day.date,
                  type: isMyPurchase ? "Einkauf" : "Verkauf",
                  price: t.price,
                  partner: isMyPurchase ? t.seller : t.buyer
                });
              }
            }
          });
        });

        addDebug(`Found ${entries.length} transfers`);

        fillTransferTable("#transferTableAll tbody", entries);
        fillTransferTable("#transferTableBuy tbody", entries.filter(e => e.type === "Einkauf"));
        fillTransferTable("#transferTableSell tbody", entries.filter(e => e.type === "Verkauf"));

        // Initial nach Datum (neueste zuerst) sortieren
        document.querySelectorAll('.rivals-table').forEach(table => {
          sortTable(table, 0); // Erste Spalte (Datum)
          sortTable(table, 0); // Zweimal f√ºr absteigende Sortierung
        });

      } catch (error) {
        addDebug("ERROR in renderTransfers: " + error.message);
        console.error(error);
      }

      addDebug("=== renderTransfers END ===");
    }

    // Hilfsfunktion zum F√ºllen der Transfers-Tabellen
    function fillTransferTable(selector, list) {
      console.group('fillTransferTable');
      addDebug(`Processing ${selector} with ${list.length} entries`);

      try {
        const tbody = document.querySelector(selector);
        if (!tbody) {
          throw new Error(`Table body not found: ${selector}`);
        }

        tbody.innerHTML = "";

        list.forEach((e, index) => {
          const tr = document.createElement('tr');

          // Try to find player in database
          const player = e.playerId ? playersData.playerDB.find(p => p.id === e.playerId) : null;
          const displayName = player?.name || e.playerName || 'Unbekannt';

          // Create cell content
          const playerCell = player ?
            `<a href="${getPlayerUrlWithParams(e.playerId)}" target="_self">${displayName}</a>` :
            displayName;

          // Build row content
          if (selector.includes("All")) {
            tr.innerHTML = `
                        <td data-sort="${formatDateForSort(e.date)}">${e.date}</td>
                        <td>${playerCell}</td>
                        <td data-sort="${e.type}">${e.type}</td>
                        <td data-sort="${e.price}">‚Ç¨${e.price.toLocaleString('de-DE')}</td>
                        <td data-sort="${e.partner?.toLowerCase() || ''}">${e.partner}</td>
                    `;
          } else {
            tr.innerHTML = `
                        <td data-sort="${formatDateForSort(e.date)}">${e.date}</td>
                        <td>${playerCell}</td>
                        <td data-sort="${e.price}">‚Ç¨${e.price.toLocaleString('de-DE')}</td>
                        <td data-sort="${e.partner?.toLowerCase() || ''}">${e.partner}</td>
                    `;
          }
          tbody.appendChild(tr);
        });

        addDebug(`Successfully filled table ${selector}`);

      } catch (error) {
        addDebug(`Error in fillTransferTable: ${error.message}`);
        console.error(error);
      }

      console.groupEnd();
    }

    // User info helpers moved to js/userInfo.js


    // Hilfsfunktionen (fetchJSON, addDebug, showLoading, hideLoading, showContent) sollten in deinen utils.js o.√§. liegen

    // Nach Laden der Seite starten
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      initTabs();

      // Spaltensortierung hinzuf√ºgen
      const tables = document.querySelectorAll('.rivals-table');
      tables.forEach(table => {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
          header.addEventListener('click', () => {
            sortTable(table, index);
          });
          header.style.cursor = 'pointer';
        });
      });
    });

    // Hilfsfunktion zum Formatieren des Datums f√ºr die Sortierung (z.B. "30.09.2025" -> "20250930")
    function formatDateForSort(dateStr) {
      const [day, month, year] = dateStr.split('.');
      return year + (month.padStart(2, '0')) + (day.padStart(2, '0'));
    }

    function sortTable(table, column) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Pr√ºfe ob die Spalte numerisch sortiert werden soll anhand des ersten data-sort Werts
      let firstCell = rows[0]?.cells[column];
      let sortValue = firstCell?.getAttribute('data-sort') || firstCell?.textContent || '';
      const isNumeric = !isNaN(sortValue);

      rows.sort((a, b) => {
        let aVal = a.cells[column].getAttribute('data-sort') || a.cells[column].textContent;
        let bVal = b.cells[column].getAttribute('data-sort') || b.cells[column].textContent;

        if (isNumeric) {
          // Konvertiere leere Werte zu 0 f√ºr numerische Sortierung
          return (parseFloat(aVal) || 0) - (parseFloat(bVal) || 0);
        }
        // Case-insensitive String-Vergleich
        return aVal.toLowerCase().localeCompare(bVal.toLowerCase());
      });

      // Toggle Sortierrichtung
      if (table.getAttribute('data-sort-column') === column.toString()) {
        rows.reverse();
        table.removeAttribute('data-sort-column');
      } else {
        table.setAttribute('data-sort-column', column);
      }

      // Neue Sortierung anwenden
      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
    }
  </script>



</body>

</html>